<html>
    <head>
        <title> Chuyện gõ tiếng Việt trên Linux | Huy's Blog</title>
        <meta charset="utf-8">
        <meta http-equiv="content-type" content="text/html;"><meta name=viewport content="initial-scale=1.0 maximum-scale=1.0">
        
        <link href="../css/inconsolata.css" rel="stylesheet" type="text/css">
        <link href="../css/theme.css" rel="stylesheet" type="text/css">
        <link rel="stylesheet" href="../css/highlight/tomorrow.css">
        <link rel="stylesheet" href="../css/fontello.css">
        <script src="../js/highlight.pack.js"></script>
        <script src="../js/autosizing.js"></script>
        <script>
        hljs.initHighlightingOnLoad();
        </script>
    </head>
    <body>
        <div class="header">
            <a href="/"><i class="icon icon-emo-coffee"></i> Huy's Blog</a>
        </div>
        <div class="container">
            <div class="main">
                <h1 id="chuy-n-g-ti-ng-vi-t-tr-n-linux">Chuyện gõ tiếng Việt trên Linux</h1>
<p>Hẳn là các bạn xài Linux (dù là distro nào) thì cũng đều gặp phải một vấn đề giống nhau, đó là <strong>gõ tiếng Việt</strong>.</p>
<p>Đã từng gõ tiếng Việt trên Windows với Unikey hay Vietkey ngày xưa thì hẳn ai cũng cảm thấy khá là khó chịu với cái dấu <u>gạch đít</u> quái đản khi chuyển qua xài macOS hoặc Linux. Đối với các bạn chưa biết, thì dấu này gọi là preedit và là một phương pháp &quot;chính thống&quot; theo lời tác giả <a href="https://github.com/lewtds">Trung Ngo</a> (thành viên team phát triển BogoEngine) trong bài viết <a href="http://lewtds.github.io/2014/07/31/uoc-mo-bo-go-kieu-unikey/">Ước mơ bộ gõ kiểu Unikey</a>.</p>
<h2 id="hai-c-ch-g-ti-ng-vi-t">Hai cách gõ tiếng Việt</h2>
<p>Đại ý của bài viết trên thì: tựu chung, các bộ gõ tiếng Việt hiện nay có <strong>2 cách</strong> để xử lý tiếng Việt khi gõ, đó là <strong>Backspace</strong> và <strong>Preedit</strong>.</p>
<ul>
<li><strong>Preedit</strong>: là cách gõ xuất hiện dấu <u>gạch đít</u>, đây thực chất là một vùng buffer lưu tạm các kí tự đang gõ, thay thế nó, ví dụ <code>aa</code> đưọc thay thành <code>â</code>, khi ngưòi dùng nhấn space để kết thúc từ đang gõ thì nó sẽ commit từ đó về cho UI của ứng dụng. Các bộ gõ tiếng Việt sử dụng kĩ thuật này thì có: ibus-unikey, bộ gõ tiếng Việt mặc định của macOS,...</li>
<li><strong>Backspace giả</strong>: là cách gõ không xuất hiện dấu <u>gạch đít</u>, cơ chế hoạt động của giải pháp này là khi gõ các kí tự tiếng việt như <code>aa</code>, bộ gõ sẽ tự động gửi 2 dấu <code>backspace</code> vào ứng dụng, và gửi tiếp một kí tự <code>â</code> thay thế. Các bộ gõ sử dụng kĩ thuật này có ibus-bogo, fcitx-bogo, GoTiengViet trên macOS,...</li>
</ul>
<h2 id="k-thu-t-backspace">Kĩ thuật Backspace</h2>
<p>Lại nói về <strong>Backspace giả</strong>, trong bài viết của mình, tác giả Trung Ngo có nói:</p>
<blockquote>
<p>Gần như tất cả các bộ gõ trên Windows (tôi không dám chắc nhưng không thể kiểm chứng được vì phần lớn là phần mềm nguồn đóng) giải quyết vấn đề này bằng cách sử dụng dấu backspace giả. </p>
</blockquote>
<p>Mình nghĩ là đúng, ít ra là với một vài bộ gõ như GoTiengViet trên Windows (không biết phiên bản trên macOS và Linux anh Trần Kỳ Nam có cải tiến hay sử dụng kĩ thuật khác không, mình không kiểm chứng đưọc), vì từng có một thời gian lúc mình còn tham gia diễn đàn <a href="http://caulacbovb.com">Câu lạc bộ VB</a>, mọi ngưòi cũng thảo luận về vấn đề phát triển bộ gõ, kĩ thuật hồi đó mọi ngưòi áp dụng là: </p>
<pre><code>- Hook keyboard để bắt lại các kí tự đang gõ
- Đưa kí tự vừa đưọc hook vào buffer và kiểm tra theo luật gõ (Telex, VNI,...)
- Gửi backspace để xóa các kí tự đã gõ, ví dụ `aa`
- Đưa kí tự cần thay thế, ví dụ `â`, vào clipboard và gửi phím `Shift + Insert` 
  hoặc `Ctrl + V` để &quot;dán&quot; kí tự này vào ứng dụng đang chạy.
- Hoặc gửi trực tiếp kí tự cần thay thế vào thông qua API của Windows
</code></pre><p>Và thêm một lý do nữa đó là lần cuối cùng mình check thì không nhớ trên Windows có API nào để hỗ trợ các kĩ thuật khác ngoài chuyện send key.</p>
<p>Hiện giờ nội dung các bài thảo luận đó vẫn còn, các bạn có thể tìm đọc để hiểu thêm:</p>
<ul>
<li>[1] <a href="http://caulacbovb.com/forum/viewtopic.php?t=27082">Từng bưóc xây dựng bộ gõ Tiếng Việt</a>, tuyen_dt18</li>
<li>[2] <a href="http://caulacbovb.com/forum/viewtopic.php?t=13876">Mã nguồn bộ gõ VBKey của bài viết trên</a>, tuyen_dt18</li>
<li>[3] <a href="http://caulacbovb.com/forum/viewtopic.php?f=41&amp;t=5858">Thread trao đổi về quá trình phát triển của bộ gõ GoTiengViet</a>, Trần Kỳ Nam</li>
<li>[4] <a href="http://caulacbovb.com/forum/viewtopic.php?f=41&amp;t=3238&amp;start=20#p36775">Đoạn trao đổi về việc nên dùng Ctrl + V hay Shift + Insert</a>, Trần Kỳ Nam (GoTiengViet) và Tienlbhoc (DotNetKey)</li>
</ul>
<h2 id="c-u-tr-c-m-t-b-g-th-ng-th-ng-tr-n-linux">Cấu trúc một bộ gõ thông thường trên Linux</h2>
<p>Phải nói là trên <strong>X Window System</strong> mới đúng. Các bộ gõ khác nhau có nhiều cách xử lý khác nhau, đoạn này mình chỉ nói đến các bộ gõ dùng kiến trúc <strong>X Input Method</strong> (XIM) như <strong>ibus</strong>, <strong>SCIM</strong>,...</p>
<p>Nếu để ý, các bạn sẽ thấy các bộ gõ như <code>ibus-bogo</code> hay <code>scim-unikey</code> thưòng hay tự gọi mình là một frontend cho một cái engine gì đó để dùng với <code>ibus</code> hoặc <code>scim</code>:</p>
<blockquote>
<p>IBus frontend for the BoGo engine.</p>
<p>scim-unikey là một bộ xử lý nhập liệu tiếng Việt cho scim, sử dụng engine xử lý tiếng Việt của unikey</p>
</blockquote>
<p>Đọc phần này sẽ giúp các bạn hiểu thêm về cái vụ &quot;engine gì đó&quot; đó.</p>
<p>Hình sau mô tả toàn cảnh việc xử lý nhập liệu trong một hệ thống X Window System:</p>
<p><img src="img/xinputmethod-arch.png" alt=""></p>
<div style="text-align: center;" class="copyright">Hình vẽ lại từ tài liệu <a href="http://menehune.opt.wfu.edu/Kokua/Irix_6.5.21_doc_cd/usr/share/Insight/library/SGI_bookshelves/SGI_Developer/books/XLib_PG/sgi_html/ch11.html">Xlib Programming Manual - Chapter 11: Internationalized Text Input</a></div>

<ul>
<li>Khi user nhấn một phím trên bàn phím, keycode của phím này sẽ đưọc gửi về cho X Server.</li>
<li>X Server gửi một sự kiện  nhấn phím (KeyPress Event) tới cho các X client đang đăng ký chờ event (application sẽ làm nhiệm vụ báo cho client biết nó có nên đăng kí nhận event hay ko)</li>
<li>Event loop trên X client sẽ đọc KeyPress Event đó bằng một lệnh gọi tới hàm <code>XNextEvent()</code></li>
<li>Thông tin của Event này sẽ được gửi sang Input Method (ibus, scim,...) và tại đây, tùy theo mỗi bộ gõ khác nhau, mà sẽ thực hiện việc kiểm tra các tổ hợp phím đưọc nhấn, rồi thay thế kí tự cho phù hợp với tập luật của bộ gõ, các nhà phát triển thưòng viết riêng phần xử lý này thành một engine để có thể sử dụng lại với nhiều loại bộ gõ khác nhau.</li>
<li>Trong quá trình xử lý (compose), Input Method cũng sẽ báo lại cho application biết để nó update phần preedit cho phù hợp.</li>
<li>Sau khi xử lý xong, Input Method sẽ gửi lại nội dung đã đưọc xử lý (một từ tiếng Việt hoàn chỉnh - composed text) về cho X client để in ra màn hình (bưóc này là bước commit). Commit xong thì application cũng thôi không in cái preedit ra nữa.</li>
</ul>
<p>Engine xử lý việc bỏ dấu (thay thế kí tự phù hợp với tập luật của bộ gõ) có rất nhiều loại khác nhau, đây là <a href="https://github.com/BoGoEngine/bogo-logic/blob/master/literate-src/Bogo.adoc">tài liệu mô tả logic</a> cho engine mà <code>ibus-bogo</code> sử dụng.</p>
<p>Việc trao đổi giữa X client và Input Method được thực hiện thông qua một phương thức gọi là XIM Protocol.</p>
<p>Và như các bạn thấy thì mô hình này phụ thuộc lớn vào preedit, chính vì vậy mới nói preedit là phưong pháp chuẩn cho việc soạn thảo với các ngôn ngữ ngoài tiếng Anh.</p>
<h2 id="th-nghi-m-c-c-b-g-tr-n-linux">Thử nghiệm các bộ gõ trên Linux</h2>
<p>Vì phần lớn thời gian làm việc của mình là trên terminal, nên chuyện chấp nhận thưong đau mà dùng Preedit khi gõ lệnh hay xài trong VIM thì mình chịu, không làm đưọc, nên dù không hoàn thiện, mình vẫn chấp nhận được các bộ gõ dùng phưong pháp dùng Backspace, vậy nên bài viết này mình chỉ nhắm tới việc tìm ra bộ gõ xài Backspace hoạt động hiệu quả nhất trên Linux.</p>
<h3 id="xvnkb">xvnkb</h3>
<p>Bộ gõ đầu tiên mình tìm hiểu thử là <code>xvnkb</code>, vì khá ấn tưọng với cái dòng release notes trên trang chủ:</p>
<blockquote>
<p>WoW! After 6 years, we have a new official release! L0LzZzzZZzz...
Some bugs with Firefox and other apps have been fixed in this release.
Still having fun! Hahaha!</p>
</blockquote>
<p>LOL.</p>
<p>Quá trình download và cài đặt diễn ra rất trơn tru, không có lỗi gì xảy ra.</p>
<p>Nhưng sau khi cài đặt xong và restart lại máy tính thì <code>xvnkb</code> làm crash luôn X server và máy tính không thể khởi động vào môi trưòng đồ họa đưọc nữa, đáng lý ra thì tới đây mình phải tìm hiểu thêm lý do crash là gì nhưng vì vừa tốn công cài đặt lại máy xong, khá là lưòi, không thấy chạy nữa thì cứ remove thẳng tay thôi :)) thành thật xin lỗi tác giả.</p>
<p>Thế là ứng viên đầu tiên đã bị loại.</p>
<h3 id="ibus-bogo">ibus-bogo</h3>
<p>Thật sự là sau khi đọc bài viết của tác giả Trung Ngo và xem homepage của project trên Github xong thì không muốn xài <code>ibus-bogo</code> tí nào, nhưng vì đã hết option rồi nên thôi cài vào xài luôn. Quá trình cài đặt thì khá là đơn giản:</p>
<pre><code>$ sudo pacman -S ibus
$ yaourt -S ibus-bogo
</code></pre><p>Để <code>ibus</code> tự động khởi động thì chúng ta có thể thêm dòng sau vào <code>~/.xinitrc</code>:</p>
<pre><code>ibus-daemon -drx
</code></pre><p>Kết quả gõ thử nghiệm cho thấy <code>ibus-bogo</code> hoạt động rất tốt trên terminal, trên các trình duyệt như <code>surf</code>, <code>firefox</code>,... không hiện thanh preedit phiền toái.</p>
<p>Tuy nhiên với chế độ gõ TELEX, một vài từ có các nguyên âm <code>ươ</code> như <code>trước, bước, nước</code>, ta bắt buộc phải gõ <code>uwow</code> hoặc <code>uow</code> nếu không muốn bị sót mất chữ <code>ơ</code>, ví dụ <code>nưóc, trưóc</code>. Các bộ gõ như GoTiengViet hay Unikey trên Mac và Windows không bị trường hợp này.</p>
<p>Một nhược điểm khác của <code>ibus-bogo</code> là không hỗ trợ các trình duyệt <code>Chromium</code>, <code>Google Chrome</code>, lý do thì tác giả Trung Ngo đã giải thích trong <a href="https://github.com/BoGoEngine/ibus-bogo/issues/216">Issue #216 - ibus-bogo</a>.</p>
<p>Lý do lớn nhất khiến nhiều người ngại dùng <code>ibus-bogo</code> có lẽ là vì project này đã không còn được maintain nữa. Ở thời điểm viết bài này, có <strong>63 open issues</strong> trên trang Github của project. Thành viên của team phát triển là Trung Ngo đã ngừng maintain dự án vì bất đồng quan điểm với tác giả <a href="https://github.com/cmpitg">Ha-Duong Nguyen</a> và fork ra một project khác tên là <a href="https://github.com/NgoHuy/ibus-ringo"><code>ibus-ringo</code></a> (project này add thêm vài chức năng khác trong đó có preedit, nên mình ko xài :D)</p>
<h3 id="fcitx-bogo">fcitx-bogo</h3>
<p>Một phiên bản khác cũng dùng <code>BogoEngine</code> đó là <code>fcitx-bogo</code>, xây dựng cho <code>fcitx</code>. Cách cài đặt thì cũng đơn giản:</p>
<pre><code>$ pacman -S fcitx
$ yaourt -S fcitx-bogo
</code></pre><p>Khởi động với lệnh sau trong <code>~/.xinitrc</code>:</p>
<pre><code>fcitx -d
</code></pre><p>Kết quả thử nghiệm cho thấy bộ gõ này hoạt động tạm gọi là tốt trên mọi phần mềm, trong đó đặc biệt là có thể gõ đưọc tiếng Việt trên <code>Chromium</code> và <code>Google Chrome</code> luôn.</p>
<p>Tuy nhiên khi sử dụng trên terminal thì khá là lag, thời gian từ lúc gõ phím cho tới lúc hiện ra kí tự tiếng Việt rất chậm, không như <code>ibus-bogo</code>, và thêm một điểm trừ nữa là rất không ổn định, hay bung lụa kiểu:</p>
<p><img src="img/fcitx-bogo-bung-lua.png" alt=""></p>
<div class="copyright" style="text-align: center">^B chính là phím backspace đó (￣▽￣)</div>

<p>Và khi gõ trên <code>Firefox</code> thì vẫn gặp hiện tượng không gõ đầy đủ dduwocj tiêngs Viêjt =.= (đó, bị như vậy đó).</p>
<h2 id="k-t-lu-n">Kết luận</h2>
<p>Hy vọng bài viết này giúp các bạn có thêm cái nhìn sâu hơn về các loại bộ gõ tiếng Việt hiện có và những thử thách về mặt kĩ thuật mà chúng ta đang phải đối mặt để có thể phát triển đưọc một bộ gõ tiếng Việt hoàn chỉnh cho môi trưòng Linux. </p>
<p>Bài viết chỉ dựa trên quan điểm chủ quan của tác giả khi tìm hiểu về các bộ gõ không dùng preedit, nên còn nhiều thiếu sót và có nhiều nội dung liên quan đến phưong pháp chuẩn (preedit) và các kĩ thuật khác như surrounding text,... đã bị bỏ qua. </p>
<p>Hy vọng các bạn quan tâm có thể nhiệt tình góp ý, bổ sung và giúp mình hoàn thiện bài viết. Xin cảm ơn :D</p>
<div class='other-tags'><b>Tags:</b> <a class='topic-tag' href='https://huytd.github.io/tags/linux.html'>linux</a><a class='topic-tag' href='https://huytd.github.io/tags/opinion.html'>opinion</a><a class='topic-tag' href='https://huytd.github.io/tags/algorithm.html'>algorithm</a></div>
                <div class="copyright">
                Bạn được tùy ý bấm like, trích dẫn hoặc copy, post lại, nhưng vui lòng ghi rõ nguồn và tác giả và không làm thay đổi nội dung bài viết. Nếu không làm vậy, mình hy vọng từ nay về sau bạn sẽ luôn cảm thấy cắn rứt lương tâm, ăn không ngon, ngủ không yên. 😆
                </div>
                <!-- Comment -->
                <div class="comments">
                  <div id="comment-loading" class="loading"></div>
                  <div id="login-box" class="login">
                    Bạn cần <button onclick="login()">Login</button> để comment
                  </div>
                  <div id="comment-box" class="comment-input">
                    <div class="avatar">
                      <img id="user-avatar" src="" width="32" height="32"/>
                    </div>
                    <div class="input">
                      <textarea id="comment-content" onkeyup="autoSizing(this)" onkeydown="submitComment(event)" placeholder="Comment gõ vào đây :D"></textarea>
                      <span>Gõ xong nhấn <kbd>Ctrl</kbd> + <kbd>Enter</kbd> để gửi.</span>
                    </div>
                  </div>
                  <ul id="comment-list" class="comment-list"></ul>
                </div>
                <!-- End Comment -->
            </div>
        </div>
	    <div class="footer">
            <p>Created with <a href="http://github.com/huytd/azeroth-js">azeroth.js</a></p>
            <div class="social">
                <a target="_blank" href="http://facebook.com/kingbazoka"><i class="icon-facebook-squared"></i></a>
                <a target="_blank" href="http://twitter.com/huydotnet"><i class="icon-twitter-squared"></i></a>
                <a target="_blank" href="http://github.com/huytd"><i class="icon-github-squared"></i></a>
                <a target="_blank" href="https://thefullsnack.com"><i class="icon-emo-coffee"></i></a>
            </div>
        </div>
        <script type="text/javascript" async src="https://cdn.rawgit.com/mathjax/MathJax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
        <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
          tex2jax: {
            inlineMath: [['$','$'], ['\\(','\\)']],
            skipTags: ["script","noscript","style","textarea"]
          }
        });
        </script>
        <script src="https://www.gstatic.com/firebasejs/3.8.0/firebase.js"></script>
        <script>
          // Initialize Firebase
          var config = {
            apiKey: "AIzaSyA1PnIAlJJ-U6iQJMNnCOknBuziBqGMYcY",
            authDomain: "huys-blog-comment.firebaseapp.com",
            databaseURL: "https://huys-blog-comment.firebaseio.com",
            projectId: "huys-blog-comment",
            storageBucket: "huys-blog-comment.appspot.com",
            messagingSenderId: "317330376829"
          };
          firebase.initializeApp(config);
        </script>
        <script>
          let provider = new firebase.auth.GoogleAuthProvider();
          let auth = firebase.auth();
          let currentUser = null;
          let postCommentURL = 'posts/go-tieng-viet-linux/comments';

          auth.onAuthStateChanged(function(user) {
            document.getElementById("comment-loading").style.display = "none";
            if (user) {
              currentUser = user;
              // Logged in
              document.getElementById("login-box").style.display = "none";
              document.getElementById("comment-box").style.display = "flex";
              document.getElementById("user-avatar").setAttribute("src", user.photoURL);
            } else {
              // Not login yet
              document.getElementById("comment-box").style.display = "none";
              document.getElementById("login-box").style.display = "block";
            }
          });

          const login = function() {
            auth.signInWithPopup(provider)
              .then(function(result) {
              }).catch(function(err) {
              });
          };

          const encodeHTML = function(s) {
            return s.replace(/</g, '&lt;').replace(/"/g, '&quot;').replace(/>/g, '&gt;');
          };

          const saveNewComment = function(comment) {
            if (!currentUser) {
              return;
            }
            let commentData = {
              user: currentUser.displayName,
              avatar: currentUser.photoURL,
              time: (new Date()).toISOString(),
              message: encodeHTML(comment)
            };
            database.ref(postCommentURL).push(commentData);
            document.getElementById("comment-content").value = "";
          };

          const submitComment = function(e) {
            let keyCode = e.which || e.keyCode;
            let ctrlCode = e.ctrlKey || e.metaKey;
            if (keyCode === 13 && ctrlCode) {
              let comment = document.getElementById("comment-content").value;
              saveNewComment(comment);
            }
          };

          const filterURLinComment = function(comment) {
            return comment.replace(/(https?:\/\/(?:www\.|(?!www))[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|www\.[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|https?:\/\/(?:www\.|(?!www))[a-zA-Z0-9]\.[^\s]{2,}|www\.[a-zA-Z0-9]\.[^\s]{2,})/g, "<a target='_blank' rel='noopener noreferrer' href='$1'>$1</a>");
          };

          const addNewComment = function(user, avatar, time, comment) {
            let commentFiltered = encodeHTML(comment);
            commentFiltered = filterURLinComment(commentFiltered);
            let d = new Date(time);
            let commentTime = d.toLocaleTimeString() + ' ' + d.toLocaleDateString();
            let html = '<div class="avatar">' +
              '   <img src="' + avatar + '" width="32" height="32"/>' +
              ' </div>' +
              '<div class="comment">' +
              '  <div class="metadata"><b>' + user + '</b> lúc <span>' + commentTime + '</span></div>' +
              '  <div class="content">' + commentFiltered
              '  </div>' +
              '</div>';
            let li = document.createElement('li');
            li.innerHTML = html;
            document.getElementById("comment-list").append(li);
          };

          let database = firebase.database();
          let posts = database.ref(postCommentURL).orderByChild('time');
          posts.on('child_added', function(data) {
            addNewComment(data.val().user, data.val().avatar, data.val().time, data.val().message);
          });
        </script>
    </body>
</html>
