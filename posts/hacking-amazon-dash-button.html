<html>
    <head>
        <title> Hacking Amazon Dash Button | Huy's Blog</title>
        <meta charset="utf-8">
        <meta http-equiv="content-type" content="text/html;"><meta name=viewport content="initial-scale=1.0 maximum-scale=1.0">
        
        <link href="../css/inconsolata.css" rel="stylesheet" type="text/css">
        <link href="../css/theme.css" rel="stylesheet" type="text/css">
        <link rel="stylesheet" href="../css/highlight/tomorrow.css">
        <link rel="stylesheet" href="../css/fontello.css">
        <script src="../js/highlight.pack.js"></script>
        <script src="../js/autosizing.js"></script>
        <script>
        hljs.initHighlightingOnLoad();
        </script>
    </head>
    <body>
      <div class="notice">N·ªôi dung tr√™n blog n√†y ƒë∆∞·ª£c c·∫≠p nh·∫≠t l·∫ßn cu·ªëi v√†o l√∫c <b>11:50 02/05/2017</b>.<br/>T·ª´ gi·ªù blog s·∫Ω chuy·ªÉn sang nh√† m·ªõi l√† <a href="https://thefullsnack.com">https://thefullsnack.com</a>. Mong c√°c b·∫°n gh√© ch∆°i <i class="icon icon-emo-coffee"></i></div>
        <div class="header">
            <a href="/"><i class="icon icon-emo-coffee"></i> Huy's Blog</a>
        </div>
        <div class="container">
            <div class="main">
                <h1 id="hacking-amazon-dash-button">Hacking Amazon Dash Button</h1>
<p>Amazon Dash Button l√† m·ªôt thi·∫øt b·ªã k·∫øt n·ªëi Wifi v√† ch·ªâ c√≥ 1 n√∫t b·∫•m. Sau khi mua v·ªÅ v√† c√†i ƒë·∫∑t xong, th√¨ khi b·∫•m c√°i n√∫t n√†y, n√≥ s·∫Ω t·ª± ƒë·ªông g·ª≠i request ƒë·∫øn Amazon ƒë·ªÉ order m√≥n ƒë·ªì m√† b·∫°n ƒë√£ ch·ªçn tr∆∞√≥c ƒë√≥. </p>
<p>B·∫°n c√≥ th·ªÉ d√πng n√≥ ƒë·ªÉ order m√¨ t√¥m, b√°nh k·∫πo, s·ªØa, b·ªôt gi·∫∑t, c√† ph√™, hay b·∫•t c·ª© th·ª© g√¨ t√πy th√≠ch. Tuy nhi√™n b·∫°n ch·ªâ ƒë∆∞·ªçc order nh·ªØng m·∫∑t h√†ng c·ªßa m·ªôt h√£ng cho m·ªôt n√∫t, t√πy theo nh√£n in tr√™n n√∫t ƒë√≥.</p>
<p><img src="img/dashbutton.jpg" alt=""></p>
<div style="text-align: center;" class="copyright">H√¨nh ·∫£nh b·ª£ t·ª´ blog <a href="https://mpetroff.net/2015/05/amazon-dash-button-teardown/">Matthew Petroff: Amazon Dash Button Teardown</a></div>

<h2 id="c-u-h-nh-b-n-trong">C·∫•u h√¨nh b√™n trong</h2>
<p>Tuy b·ªÅ ngo√†i nh√¨n kh√° l√† ƒë∆°n gi·∫£n, nh∆∞ng b√™n trong Dash button c√≥ r·∫•t nhi·ªÅu th·ª© hay ho:</p>
<ul>
<li>D√πng chip x·ª≠ l√Ω <code>ARM Cortex-M3</code> (STM32F205RG6), xung nh·ªãp l√™n ƒë·∫øn <code>120 MHz</code>.</li>
<li>Chip n√†y c√≥ <code>128 KB</code> RAM v√† <code>1 MB</code> b·ªô nh·ªõ flash ƒë·ªÉ ch·ª©a ch∆∞ong tr√¨nh ƒëi·ªÅu khi·ªÉn.</li>
<li>Chip n√†y c√≤n t√≠ch h·ª£p lu√¥n module WIFI <code>BCM943362</code>.</li>
<li>C√≥ 1 microphone t√≠ch h·ª£p.</li>
<li>C√≥ 1 ƒë√®n LED RGB.</li>
<li>C·∫•p ngu·ªìn b·∫±ng 1 c·ª•c pin <code>Energizer Ultimate Lithium AAA</code> c√≥ t·ª≠u l∆∞·ªçng... nh·∫ßm, th·ªùi l∆∞·ªçng l√™n ƒë·∫øn 20 nƒÉm</li>
</ul>
<p>V√† t·∫•t nhi√™n v·ªõi kh·∫£ nƒÉng k·∫øt n·ªëi wifi c√πng th·ªùi l∆∞·ªçng pin tr√¢u b√≤ c·ªßa n√≥, th√¨ vi·ªác d√πng n√≥ ƒë·ªÉ l√†m c√°i n√∫t order b·ªâm s·ª≠a c√≥ v·∫ª h∆°i b·ªã ph√≠. Ch∆∞a k·ªÉ l√† ƒë∆∞·ª£c b√°n v·ªõi gi√° r·∫ª b√®o nh∆∞ cho kh√¥ng (t·ª´ <code>0.99$</code> - <code>4.99$</code>) th√¨ ƒë√¢y qu·∫£ l√† m·ªôt m√≥n ƒë·ªì ch∆°i l√Ω t∆∞·ªüng cho d√¢n ghi·ªÅn c√¥ng ngh·ªá.</p>
<p>Ch∆∞a h·∫øt, sau khi mua 1 em Dash n√†y v·ªÅ, th√¨ b·∫°n s·∫Ω ƒë∆∞·ª£c gi·∫£m gi√° ngay 4.99$ cho order ƒë·∫ßu ti√™n. V√¨ b·∫°n Evan nh√† m√¨nh chu·∫©n b·ªã m·ªçc rƒÉng, r·∫•t th√≠ch nhai b·∫•t c·ª© th·ª© g√¨ b·∫°n ·∫•y v·ªõ ƒë∆∞·ª£c n√™n h√¥m qua m√¨nh order m·ªôt c·ª•c chew toy gi√° <code>5$</code> v√† ƒë∆∞·ªçc gi·∫£m gi√° ngay l·∫≠p t·ª©c, d√π l√† c√°i Dash button mua ch·ªâ c√≥ <code>0.99$</code> :))</p>
<p>Gi·ªù v√¥ ch·ªß ƒë·ªÅ ch√≠nh: <strong>Hack c√°i n√∫t Dash button</strong>.</p>
<h2 id="hacking">Hacking</h2>
<p>M√¥ h√¨nh ho·∫°t ƒë·ªông c·ªßa Dash button c√≥ d·∫°ng nh∆∞ sau: </p>
<pre><code> .--------.
| DASH ( ) | -------&gt; INTERNET -------&gt; AMAZON SERVER
 `--------&#39;
</code></pre><p>Sau khi b·∫°n nh·∫•n n√∫t, n√≥ s·∫Ω g·ª≠i m·ªôt request t·ªõi server c·ªßa Amazon v√† th·ª±c hi·ªán l·ªánh order. Vi·ªác ch√∫ng ta c·∫ßn l√†m l√† l·∫≠p m·ªôt server ƒë·ªÉ listen v√† ch·∫∑n h·∫øt c√°c g√≥i tin do Dash g·ª≠i ƒëi. ƒê·ªìng th·ªùi v√¨ ƒë√£ b·∫Øt ƒë∆∞·ª£c event nh·∫•n n√∫t, coi nh∆∞ ch√∫ng ta c√≥ th·ªÉ d√πng Dash ƒë·ªÉ ƒëi·ªÅu khi·ªÉn th·ª© g√¨ ƒë√≥ theo √Ω m√¨nh t√πy th√≠ch.</p>
<pre><code> .--------.
| DASH ( ) | -------&gt; NODE SERVER ----X     INTERNET
 `--------&#39;                |
                           |
                            `-------&gt; L√†m tr√≤ m√®o
</code></pre><h3 id="c-i-t-dash-button">C√†i ƒë·∫∑t Dash Button</h3>
<p>Sau khi order v·ªÅ, th√¨ vi·ªác ƒë·∫ßu ti√™n c·∫ßn l√†m ƒë√≥ l√† c·∫•u h√¨nh cho c√°i n√∫t k·∫øt n·ªëi ƒë∆∞·ªçc v·ªõi Wifi.</p>
<p>ƒê·ªÉ c·∫•u h√¨nh th√¨ ch·ªâ c·∫ßn m·ªü app Amazon tr√™n ƒëi·ªán tho·∫°i ra, v√†o <strong>Menu -&gt; Your Account -&gt; Add new Dash Button</strong>, sau ƒë√≥ l√†m theo h∆∞·ªõng d·∫´n tr√™n app, nh·∫•n c√°i n√∫t c·ªßa Dash trong v√≤ng 6 gi√¢y cho t·ªõi khi c√°i ƒë√®n tr√™n ƒë√≥ chuy·ªÉn qua m√†u xanh th√¨ nh·∫£ ra. ƒêi·ªÅn pass Wifi v√†o.</p>
<p>Sau ƒë√≥ app Amazon s·∫Ω nh·∫£y ra m√†n h√¨nh ch·ªçn s·∫£n ph·∫©m c·∫ßn mua, t·∫°i b∆∞·ªõc n√†y nh·ªõ <strong>ƒë·ª´ng ch·ªçn c√°i g√¨ c·∫£</strong>, ch·ªâ l·∫≥ng l·∫∑ng t·∫Øt app ƒëi l√† xong.</p>
<h3 id="t-m-mac-address-c-a-dash-button">T√¨m MAC address c·ªßa Dash Button</h3>
<p>ƒê·ªÉ c√≥ th·ªÉ s·ª≠ d·ª•ng ƒë∆∞·ª£c Dash button th√¨ ch√∫ng ta c·∫ßn ph·∫£i l·∫•y ƒë·ªãa ch·ªâ MAC c·ªßa n√≥. C√°ch l·∫•y th√¨ nhi·ªÅu v√¥ k·ªÉ. C√≥ ng∆∞√≤i s·ª≠ d·ª•ng c√°c script chuy√™n d·ª•ng, c√≥ ng∆∞√≤i t·ª± vi·∫øt script ƒë·ªÉ b·∫Øt g√≥i tin v√† tra ƒë·ªãa ch·ªâ. M√¨nh ch·ªâ tr√¨nh b√†y c√°ch ƒë∆°n gi·∫£n ƒë√≥ l√† d√πng <code>tcpdump</code>.</p>
<p>ƒê·∫ßu ti√™n ch·∫°y <code>tcpdump</code>:</p>
<pre><code>$ tcpdump
</code></pre><p>N·∫øu ch∆∞a c√≥ th√¨ c√≥ th·ªÉ c√†i th√¥ng qua <code>brew</code> tr√™n macOS ho·∫∑c package manager c·ªßa b·∫£n Linux b·∫°n ƒëang x√†i, v√≠ d·ª• tr√™n Arch l√†:</p>
<pre><code>$ pacman -S tcpdump
</code></pre><p>Khi ch·∫°y th√¨ <code>tcpdump</code> s·∫Ω li·ªát k√™ to√†n b·ªô c√°c k·∫øt n·ªëi trong m·∫°ng, l∆∞u √Ω kh√¥ng n√™n s·ª≠ d·ª•ng khi ƒëang ·ªü trong m·ªôt m·∫°ng c√≥ qu√° nhi·ªÅu thi·∫øt b·ªã (v√¨ l∆∞·ªçng output s·∫Ω nhi·ªÅu, kh√≥ t√¨m). L√∫c n√†y b·∫°n c√≥ th·ªÉ b·∫•m c√°i n√∫t tr√™n Dash v√†i ba l·∫ßn v√† t√¨m output c√≥ d·∫°ng:</p>
<pre><code>22:26:52.777174 IP 0.0.0.0.bootpc &gt; 255.255.255.255.bootps: BOOTP/DHCP, 
Request from XX:XX:XX:XX:XX:XX (oui Unknown), length 261
</code></pre><p>Trong ƒë√≥ <code>XX:XX:XX:XX:XX:XX</code> s·∫Ω l√† ƒë·ªãa ch·ªâ MAC c·ªßa Dash button m√† ch√∫ng ta c·∫ßn t√¨m.</p>
<h3 id="t-o-server-trung-gian-b-t-request">T·∫°o server trung gian ƒë·ªÉ b·∫Øt request</h3>
<p>ƒê·ªÉ listen c√°c request t·ª´ Dash, ch√∫ng ta c√≥ th·ªÉ d√πng th∆∞ vi·ªán <a href="https://github.com/hortinstein/node-dash-button"><code>node-dash-button</code></a>. C√°ch l√†m r·∫•t ƒë∆°n gi·∫£n:</p>
<p>ƒê·∫ßu ti√™n, ch√∫ng ta t·∫°o m·ªôt th∆∞ m·ª•c m·ªõi cho d·ª± √°n hacking c·ªßa m√¨nh v√† kh·ªüi t·∫°o m·ªôt node project m·ªõi v·ªõi <code>yarn</code> ho·∫∑c <code>npm</code>:</p>
<pre><code>$ mkdir dashfun
$ yarn init
</code></pre><p>Ti·∫øp theo, ch√∫ng ta c√†i ƒë·∫∑t g√≥i <code>node-dash-button</code>:</p>
<pre><code>$ yarn add node-dash-button
</code></pre><p>Sau ƒë√≥ t·∫°o file <code>main.js</code> v√† b·∫Øt ƒë·∫ßu vi·∫øt code:</p>
<pre><code>$ touch main.js
</code></pre><p>N·ªôi dung file <code>main.js</code> ƒë∆°n gi·∫£n nh∆∞ th·∫ø n√†y th√¥i:</p>
<pre><code>const DashButton = require(&#39;node-dash-button&#39;);
const dash = DashButton(&quot;XX:XX:XX:XX:XX:XX&quot;, null, null, &#39;all&#39;);

dash.on(&quot;detected&quot;, function (){
    console.log(&quot;omg found&quot;);
});
</code></pre><p>Nh·ªõ thay <code>XX:XX:XX:XX:XX:XX</code> b·∫±ng ƒë·ªãa ch·ªâ MAC c·ªßa dash button b·∫°n c√≥.</p>
<p>B·∫•t c·ª© khi n√†o b·∫°n nh·∫•n n√∫t, th∆∞ vi·ªán <code>node-dash-button</code> s·∫Ω b·∫Øt c√°c g√≥i tin v√† th·ª±c thi h√†m callback c·ªßa s·ª± ki·ªán <code>detected</code>.</p>
<p>ƒê·∫øn ƒë√¢y vi·ªác hack coi nh∆∞ ho√†n th√†nh, b·∫°n c√≥ th·ªÉ th·ª±c hi·ªán thao t√°c g√¨ ƒë√≥ b·∫°n mu·ªën (pha c√† ph√™, b·∫≠t t·∫Øt ƒë√®n, request g·ª≠i tin nh·∫Øn, shutdown server, ch·∫°y l·ªánh <code>rm -rf /</code>,...) t√πy th√≠ch b√™n trong h√†m callback n√†y.</p>
<p>Video demo:</p>
<iframe width="700" height="400" src="https://www.youtube.com/embed/unKgZ29CrDM" frameborder="0" allowfullscreen></iframe>

<p>·ªû th·ªùi ƒëi·ªÉm hi·ªán t·∫°i th√¨ ch∆∞a th·∫•y ai l√†m ƒë∆∞·ªçc g√¨ nhi·ªÅu h∆°n trong vi·ªác hack em Dash button n√†y ngo√†i vi·ªác b·∫Øt l·∫°i request c·ªßa n√≥ m·ªói khi nh·∫•n n√∫t v√† th·ª±c hi·ªán m·ªôt thao t√°c kh√°c b·∫±ng server c·ªßa ch√≠nh m√¨nh. N√™n trong ph·∫°m vi b√†i vi·∫øt n√†y c≈©ng ch·ªâ ƒë·ªÅ c·∫≠p ƒë·∫øn v·∫•n ƒë·ªÅ ƒë√≥. Sau n√†y n·∫øu t√¨m hi·ªÉu ƒë∆∞·ª£c th√™m kƒ© thu·∫≠t g√¨ m·ªõi h∆°n th√¨ m√¨nh s·∫Ω vi·∫øt th√™m.</p>
<div class='other-tags'><b>Tags:</b> <a class='topic-tag' href='https://huytd.github.io/tags/hardware.html'>hardware</a><a class='topic-tag' href='https://huytd.github.io/tags/hacking.html'>hacking</a><a class='topic-tag' href='https://huytd.github.io/tags/javascript.html'>javascript</a></div>
                <div class="copyright">
                B·∫°n ƒë∆∞·ª£c t√πy √Ω b·∫•m like, tr√≠ch d·∫´n ho·∫∑c copy, post l·∫°i, nh∆∞ng vui l√≤ng ghi r√µ ngu·ªìn v√† t√°c gi·∫£ v√† kh√¥ng l√†m thay ƒë·ªïi n·ªôi dung b√†i vi·∫øt. N·∫øu kh√¥ng l√†m v·∫≠y, m√¨nh hy v·ªçng t·ª´ nay v·ªÅ sau b·∫°n s·∫Ω lu√¥n c·∫£m th·∫•y c·∫Øn r·ª©t l∆∞∆°ng t√¢m, ƒÉn kh√¥ng ngon, ng·ªß kh√¥ng y√™n. üòÜ
                </div>
                <!-- Comment -->
                <div class="comments">
                  <div id="comment-loading" class="loading"></div>
                  <div id="login-box" class="login">
                    B·∫°n c·∫ßn <button onclick="login()">Login</button> ƒë·ªÉ comment
                  </div>
                  <div id="comment-box" class="comment-input">
                    <div class="avatar">
                      <img id="user-avatar" src="" width="32" height="32"/>
                    </div>
                    <div class="input">
                      <textarea id="comment-content" onkeyup="autoSizing(this)" onkeydown="submitComment(event)" placeholder="Comment g√µ v√†o ƒë√¢y :D"></textarea>
                      <span>G√µ xong nh·∫•n <kbd>Ctrl</kbd> + <kbd>Enter</kbd> ƒë·ªÉ g·ª≠i.</span>
                    </div>
                  </div>
                  <ul id="comment-list" class="comment-list"></ul>
                </div>
                <!-- End Comment -->
            </div>
        </div>
	    <div class="footer">
        <p><a href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img src="https://thefullsnack.com/img/by-nc-sa.png" /></a></p>
            <p>Created with <a href="http://github.com/huytd/azeroth-js">azeroth.js</a></p>
            <div class="social">
                <a target="_blank" href="http://facebook.com/kingbazoka"><i class="icon-facebook-squared"></i></a>
                <a target="_blank" href="http://twitter.com/huydotnet"><i class="icon-twitter-squared"></i></a>
                <a target="_blank" href="http://github.com/huytd"><i class="icon-github-squared"></i></a>
                <a target="_blank" href="https://thefullsnack.com"><i class="icon-emo-coffee"></i></a>
            </div>
        </div>
        <script type="text/javascript" async src="https://cdn.rawgit.com/mathjax/MathJax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
        <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
          tex2jax: {
            inlineMath: [['$','$'], ['\\(','\\)']],
            skipTags: ["script","noscript","style","textarea"]
          }
        });
        </script>
        <script src="https://www.gstatic.com/firebasejs/3.8.0/firebase.js"></script>
        <script>
          // Initialize Firebase
          var config = {
            apiKey: "AIzaSyA1PnIAlJJ-U6iQJMNnCOknBuziBqGMYcY",
            authDomain: "huys-blog-comment.firebaseapp.com",
            databaseURL: "https://huys-blog-comment.firebaseio.com",
            projectId: "huys-blog-comment",
            storageBucket: "huys-blog-comment.appspot.com",
            messagingSenderId: "317330376829"
          };
          firebase.initializeApp(config);
        </script>
        <script>
          let provider = new firebase.auth.GoogleAuthProvider();
          let auth = firebase.auth();
          let currentUser = null;
          let postCommentURL = 'posts/hacking-amazon-dash-button/comments';

          auth.onAuthStateChanged(function(user) {
            document.getElementById("comment-loading").style.display = "none";
            if (user) {
              currentUser = user;
              // Logged in
              document.getElementById("login-box").style.display = "none";
              document.getElementById("comment-box").style.display = "flex";
              document.getElementById("user-avatar").setAttribute("src", user.photoURL);
            } else {
              // Not login yet
              document.getElementById("comment-box").style.display = "none";
              document.getElementById("login-box").style.display = "block";
            }
          });

          const login = function() {
            auth.signInWithPopup(provider)
              .then(function(result) {
              }).catch(function(err) {
              });
          };

          const encodeHTML = function(s) {
            return s.replace(/</g, '&lt;').replace(/"/g, '&quot;').replace(/>/g, '&gt;');
          };

          const saveNewComment = function(comment) {
            if (!currentUser) {
              return;
            }
            let commentData = {
              user: currentUser.displayName,
              avatar: currentUser.photoURL,
              time: (new Date()).getTime(),
              message: encodeHTML(comment)
            };
            database.ref(postCommentURL).push(commentData);
            document.getElementById("comment-content").value = "";
          };

          const submitComment = function(e) {
            let keyCode = e.which || e.keyCode;
            let ctrlCode = e.ctrlKey || e.metaKey;
            if (keyCode === 13 && ctrlCode) {
              let comment = document.getElementById("comment-content").value;
              saveNewComment(comment);
            }
          };

          const filterURLinComment = function(comment) {
            return comment.replace(/(https?:\/\/(?:www\.|(?!www))[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|www\.[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|https?:\/\/(?:www\.|(?!www))[a-zA-Z0-9]\.[^\s]{2,}|www\.[a-zA-Z0-9]\.[^\s]{2,})/g, "<a target='_blank' rel='noopener noreferrer' href='$1'>$1</a>");
          };

          const addNewComment = function(user, avatar, time, comment) {
            let commentFiltered = encodeHTML(comment);
            commentFiltered = filterURLinComment(commentFiltered);
            let d = new Date(time);
            let commentTime = d.toLocaleTimeString() + ' ' + d.toLocaleDateString();
            let html = '<div class="avatar">' +
              '   <img src="' + avatar + '" width="32" height="32"/>' +
              ' </div>' +
              '<div class="comment">' +
              '  <div class="metadata"><b>' + user + '</b> l√∫c <span>' + commentTime + '</span></div>' +
              '  <div class="content">' + commentFiltered
              '  </div>' +
              '</div>';
            let li = document.createElement('li');
            li.innerHTML = html;
            document.getElementById("comment-list").append(li);
          };

          let database = firebase.database();
          let posts = database.ref(postCommentURL).orderByChild('time');
          posts.on('child_added', function(data) {
            addNewComment(data.val().user, data.val().avatar, data.val().time, data.val().message);
          });
        </script>
    </body>
</html>
