<html>
    <head>
        <title> GPU programming v·ªõi Golang | Huy's Blog</title>
        <meta charset="utf-8">
        <meta http-equiv="content-type" content="text/html;"><meta name=viewport content="initial-scale=1.0 maximum-scale=1.0">
        
        <link href="../css/inconsolata.css" rel="stylesheet" type="text/css">
        <link href="../css/theme.css" rel="stylesheet" type="text/css">
        <link rel="stylesheet" href="../css/highlight/tomorrow.css">
        <link rel="stylesheet" href="../css/fontello.css">
        <script src="../js/highlight.pack.js"></script>
        <script>
        hljs.initHighlightingOnLoad();
        </script>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    </head>
    <body>
        <div class="header">
            <a href="/"><i class="icon icon-emo-coffee"></i> Huy's Blog</a>
        </div>
        <div class="container">
            <div class="main">
                <h1 id="gpu-programming-v-i-golang">GPU programming v·ªõi Golang</h1>
<p>·ªû <a href="https://huytd.github.io/posts/nhan-ma-tran-2.html">b√†i tr∆∞·ªõc</a> m√¨nh c√≥ gi·ªõi thi·ªáu v·ªÅ kƒ© thu·∫≠t l·∫≠p tr√¨nh GPU v·ªõi <strong>OpenCL</strong> b·∫±ng <strong>C/C++</strong>. H√¥m nay m√¨nh s·∫Ω gi·ªõi thi·ªáu ti·∫øp kƒ© thu·∫≠t n√†y tr√™n Go.</p>
<p><img src="https://archive.fosdem.org/2014/schedule/event/hpc_devroom_go/hpc_devroom_go-99c7a0bca25373a544f8d99c7e42526e04c7578bcfa3c45fc3be59fa1ada99ba.png" alt=""></p>
<h2 id="s-d-ng-c-c-trong-go">S·ª≠ d·ª•ng C/C++ trong Go</h2>
<p>M·ªôt ƒë·∫∑c ƒëi·ªÉm c·ªßa Golang l√† ch√∫ng ta c√≥ th·ªÉ tho·∫£i m√°i import c√°c th∆∞ vi·ªán C/C++ v√† bi√™n d·ªãch b·∫±ng s·ª± h·ªó tr·ª£ c·ªßa <strong>Cgo</strong>, c√°c b√°c c√≥ th·ªÉ xem l·∫°i b√†i <a href="https://huytd.github.io/posts/vai-dieu-ve-cgo.html">M·ªôt s·ªë kinh nghi·ªám l√†m vi·ªác v·ªõi Cgo</a> ƒë·ªÉ bi·∫øt th√™m chi ti·∫øt.</p>
<p>V·ªÅ c√°ch s·ª≠ d·ª•ng th√¨ ch√∫ng ta ch·ªâ ƒë∆°n gi·∫£n l√† vi·∫øt ƒëo·∫°n code <strong>C/C++</strong> trong ph·∫ßn comment ƒë·∫ßu file v√† bi√™n d·ªãch:</p>
<pre><code>package main

/*
#include &lt;stdio.h&gt;

void sayHello() {
  printf(&quot;YOLO!&quot;)
}
*/
import &quot;C&quot;

func main() {
  C.sayHello()
}
</code></pre><p>Cho n√™n ch√∫ng ta ho√†n to√†n c√≥ th·ªÉ include th∆∞ vi·ªán <strong>OpenCL</strong> t·ª´ b√™n ph√≠a <strong>C/C++</strong> v√†o Go ƒë·ªÉ ch·∫°y b·∫±ng Cgo. T·∫•t nhi√™n ph·∫£i ch·ªâ ƒë·ªãnh framework c·∫ßn d√πng ·ªü ƒë·∫ßu ch∆∞∆°ng tr√¨nh lu√¥n, v√≠ d·ª•:</p>
<pre><code>/*
#cgo CFLAGS: -Wall
#cgo LDFLAGS: -framework opencl
#include &lt;OpenCL/opencl.h&gt;
*/
</code></pre><p>Ho·∫∑c v·ªõi <strong>CUDA</strong> nh∆∞ sau:</p>
<pre><code>//#include &lt;cuda.h&gt;
//#cgo LDFLAGS: -lcuda
</code></pre><p>V√† vi·∫øt code cho <strong>Host Program</strong> nh∆∞ b√¨nh th∆∞·ªùng.</p>
<h2 id="kernel-program">Kernel Program</h2>
<p>B·∫°n c√≥ th·ªÉ l·∫≠p tr√¨nh cho <strong>Host Program</strong> b·∫±ng Golang, tuy nhi√™n, ƒë·ªëi v·ªõi <strong>Kernel Program</strong> th√¨ n√≥ v·∫´n l√† m·ªôt file <code>.cl</code> v√† n√≥ v·∫´n ph·∫£i d√πng c√∫ ph√°p c·ªßa <strong>C</strong>, ho√†n to√†n kh√¥ng c√≥ s·ª± thay ƒë·ªïi n√†o ·ªü ƒë√¢y c·∫£.</p>
<h2 id="s-d-ng-go-wrappers">S·ª≠ d·ª•ng Go Wrappers</h2>
<p>N·∫øu c·∫£m th·∫•y vi·ªác khai b√°o c√∫ ph√°p theo <strong>Cgo</strong> l√† h∆°i ph·ª©c t·∫°p v√† g√¢y r·ªëi cho ch∆∞∆°ng tr√¨nh th√¨ b·∫°n c√≥ th·ªÉ s·ª≠ d·ª•ng c√°c wrapper c√≥ s·∫µn m√† c·ªông ƒë·ªìng Golang ƒë√£ x√¢y d·ª±ng, b·∫£n ch·∫•t c√°c wrapper n√†y v·∫´n l√† s·ª≠ d·ª•ng <strong>Cgo</strong> kh√¥ng c√≥ g√¨ kh√°c, ch√∫ng ch·ªâ cung c·∫•p cho b·∫°n c√∫ ph√°p d·ªÖ nh√¨n h∆°n v√† d·ªÖ build h∆°n m√† th√¥i.</p>
<h3 id="cuda-wrapper-cho-go">CUDA Wrapper cho Go</h3>
<p>B√†i vi·∫øt n√†y kh√¥ng c√≥ √Ω ƒë·ªãnh t√¨m hi·ªÉu s√¢u h∆°n v·ªÅ <strong>CUDA</strong> cho n√™n m√¨nh s·∫Ω d·∫´n link ƒë·ªÉ c√°c b·∫°n tham kh·∫£o. </p>
<p>T√°c gi·∫£ Arne Vansteenkiste c√≥ vi·∫øt m·ªôt th∆∞ vi·ªán t√™n l√† <a href="http://mumax.github.io/index.html">$mumax^{3}$</a> h·ªó tr·ª£ l·∫≠p tr√¨nh GPU b·∫±ng <strong>CUDA</strong>, c√°c b·∫°n kh√¥ng nh·∫•t thi·∫øt ph·∫£i s·ª≠ d·ª•ng <strong>MuMax</strong> tuy nhi√™n c√≥ th·ªÉ s·ª≠ d·ª•ng <strong>CUDA</strong> wrapper m√† <strong>MuMax</strong> cung c·∫•p.</p>
<pre><code>package main

import &quot;github.com/mumax/3/cuda&quot;

func main(){
  N := 3
  a := cuda.NewSlice(N)
  b := cuda.NewSlice(N)
  c := cuda.NewSlice(N)
  defer a.Free()
  defer b.Free()
  defer c.Free()

  a.CopyHtoD([]float32{0, -1, -2})
  b.CopyHtoD([]float32{0, 1, 4})

  cfg := Make1DConfig(N)
  add_kernel(a.Ptr(), b.Ptr(), c.Ptr(), cfg)

  fmt.Println(&quot;result:&quot;, a.HostCopy())
}
</code></pre><p>Ngo√†i ra c√°c b·∫°n c√≥ th·ªÉ tham kh·∫£o th√™m slide <a href="https://hpcugent.github.io/easybuild/files/FOSDEM14/FOSDEM14_HPC_devroom_14_GoCUDA.pdf"><strong>Scientific GPU computing with Go</strong></a> ƒë·ªÉ bi·∫øt th√™m chi ti·∫øt v·ªÅ framework n√†y.</p>
<h3 id="opencl">OpenCL</h3>
<p>V·ªõi <strong>OpenCL</strong> th√¨ ch√∫ng ta c≈©ng c√≥ kha kh√° l√† nhi·ªÅu c√°c wrapper, tuy nhi√™n ·ªü ƒë√¢y m√¨nh ch·ªçn s·ª≠ d·ª•ng <a href="https://github.com/go-gl/cl"><strong>go-gl/cl</strong></a> v√¨ d·ª± √°n n√†y ƒë∆∞·ª£c ph√°t tri·ªÉn kh√° l√† nghi√™m t√∫c v√† r·∫•t active, t√†i li·ªáu + community ƒë·∫ßy ƒë·ªß. </p>
<p>C√°ch s·ª≠ d·ª•ng th√¨ r·∫•t ƒë∆°n gi·∫£n, ƒë·∫ßu ti√™n b·∫°n ch·ªâ c·∫ßn c√†i ƒë·∫∑t g√≥i <strong>go-gl/cl</strong> m·ªõi nh·∫•t, ho·∫∑c l√† b·∫£n stable nh·∫•t (l√† b·∫£n v1.2):</p>
<pre><code>go get github.com/go-gl/cl/v1.2/cl
</code></pre><p>Ho·∫∑c c√≥ th·ªÉ download v√† compile l·∫°i g√≥i n√†y v·ªõi l·ªánh sau ƒë·ªÉ ƒë·∫°t performance t·ªët h∆°n:</p>
<pre><code>go install -gcflags=&quot;-l -l -l -l&quot; github.com/go-gl/cl/v1.2/cl
</code></pre><p>L·ªánh tr√™n s·∫Ω inline h·∫ßu h·∫øt m·ªçi function trong package <strong>go-gl/cl</strong> v√† v√¨ vi·ªác g·ªçi function th√¨ r·∫•t t·ªën k√©m (<a href="http://dave.cheney.net/2014/06/07/five-things-that-make-go-fast">xem ·ªü ƒë√¢y</a>), n√™n inline s·∫Ω gi√∫p gi·∫£m thi·ªÉu chi ph√≠ cho v·ª• n√†y, tuy nhi√™n nh∆∞·ª£c ƒëi·ªÉm c·ªßa c√°ch n√†y l√† dung l∆∞·ª£ng binary khi build s·∫Ω l·ªõn h∆°n nhi·ªÅu.</p>
<p>C√°ch d√πng th√¨ ch·ªâ c·∫ßn import th∆∞ vi·ªán tr√™n v√†o code, v√† g·ªçi h√†m th√¥ng qua ƒë·ªëi t∆∞·ª£ng <code>cl</code>:</p>
<pre><code>import &quot;github.com/go-gl/cl/v1.2/cl&quot;
...
cl.CreateKernel(program, cl.Str(&quot;hello&quot;), errptr)
</code></pre><p>C√°c b·∫°n c√≥ th·ªÉ xem qua ƒëo·∫°n ch∆∞∆°ng tr√¨nh m·∫´u <a href="https://github.com/go-gl/cl/blob/master/sample/square/square.go">t√≠nh b√¨nh ph∆∞∆°ng m·ªôt s·ªë</a> ƒë·ªÉ hi·ªÉu th√™m v·ªÅ c√°ch d√πng, c≈©ng t∆∞∆°ng t·ª± nh∆∞ v·ªõi C/C++:</p>
<p>M√¨nh l∆∞·ª£t b·ªè c√°c ph·∫ßn linh tinh v√† ghi l·∫°i c√°c ph·∫ßn ch√≠nh c·∫ßn l∆∞u √Ω trong ch∆∞∆°ng tr√¨nh:</p>
<p>Import th∆∞ vi·ªán <strong>go-gl/cl</strong>:</p>
<pre><code>package main

import &quot;github.com/go-gl/cl/v1.2/cl&quot;
</code></pre><p>Khai b√°o v√† bi√™n d·ªãch <strong>Kernel</strong>:</p>
<pre><code>var KernelSource = `
__kernel void square(
   __global float* input,
   __global float* output,
   const unsigned int count)
{
   int i = get_global_id(0);
   if(i &lt; count)
       output[i] = input[i] * input[i];
}` + &quot;\x00&quot;

...


// ƒê·ªçc v√† bi√™n d·ªãch kernel program
srcptr := cl.Str(KernelSource)
program := cl.CreateProgramWithSource(context, 1, &amp;srcptr, nil, errptr)
defer cl.ReleaseProgram(program)

err = cl.BuildProgram(program, 1, &amp;device, nil, nil, nil)
</code></pre><p>L·∫•y th√¥ng tin <strong>Compute Device</strong>:</p>
<pre><code>err := cl.GetDeviceIDs(nil, cl.DEVICE_TYPE_GPU, 1, &amp;device, nil)
</code></pre><p>Kh·ªüi t·∫°o <strong>Context</strong>:</p>
<pre><code>context := cl.CreateContext(nil, 1, &amp;device, nil, nil, errptr)
defer cl.ReleaseContext(context)
</code></pre><p>Kh·ªüi t·∫°o <strong>Command Queue</strong>:</p>
<pre><code>cq := cl.CreateCommandQueue(context, device, 0, errptr)
defer cl.ReleaseCommandQueue(cq)
</code></pre><p>Kh·ªüi t·∫°o <strong>Kernel Object</strong>:</p>
<pre><code>kernel := cl.CreateKernel(program, cl.Str(&quot;square&quot;+&quot;\x00&quot;), errptr)
defer cl.ReleaseKernel(kernel)
</code></pre><p>Kh·ªüi t·∫°o <strong>Memory Object</strong>:</p>
<pre><code>input := cl.CreateBuffer(context, cl.MEM_READ_ONLY, 4*DataSize, nil, errptr)
defer cl.ReleaseMemObject(input)

output := cl.CreateBuffer(context, cl.MEM_WRITE_ONLY, 4*DataSize, nil, errptr)
defer cl.ReleaseMemObject(output)
</code></pre><p>Ghi d·ªØ li·ªáu v√†o <strong>Memory Object</strong> trong <strong>Device</strong>:</p>
<pre><code>err = cl.EnqueueWriteBuffer(cq, input, cl.TRUE, 0, 4*DataSize, unsafe.Pointer(&amp;data[0]), 0, nil, nil)
err = cl.SetKernelArg(kernel, 0, 8, unsafe.Pointer(&amp;input))
err = cl.SetKernelArg(kernel, 1, 8, unsafe.Pointer(&amp;output))
err = cl.SetKernelArg(kernel, 2, 4, unsafe.Pointer(&amp;count))
</code></pre><p>Kh·ªüi t·∫°o <strong>Work Group</strong> ƒë·ªÉ b·∫Øt ƒë·∫ßu ch·∫°y <strong>Kernel</strong>: </p>
<pre><code>err = cl.GetKernelWorkGroupInfo(kernel, device, cl.KERNEL_WORK_GROUP_SIZE, 8, unsafe.Pointer(&amp;local), nil)
err = cl.EnqueueNDRangeKernel(cq, kernel, 1, nil, &amp;global, &amp;local, 0, nil, nil)
cl.Finish(cq)
</code></pre><p>ƒê·ªçc d·ªØ li·ªáu ra b·∫±ng <strong>Channel</strong>:</p>
<pre><code>results := make([]float32, DataSize)
err = cl.EnqueueReadBuffer(cq, output, cl.TRUE, 0, 4*1024, unsafe.Pointer(&amp;results[0]), 0, nil, nil)
</code></pre><p>·ªû ch∆∞∆°ng tr√¨nh tr√™n th√¨ c√≥ s·ª± xu·∫•t hi·ªán c·ªßa k√≠ t·ª± <code>\x00</code> ·ªü ph·∫ßn <code>kernel source</code>, ƒë√¢y l√† k√≠ t·ª± <a href="https://en.m.wikipedia.org/wiki/Null_character">NULL</a> d√πng ƒë·ªÉ b√°o hi·ªáu k·∫øt th√∫c string. </p>
<p>V√† ch√∫ng ta c≈©ng th·∫•y, ·ªü ƒë√¢y ta c√≥ th·ªÉ t·∫≠n d·ª•ng lu√¥n c√°c ch·ª©c nƒÉng m√† Go cung c·∫•p m·ªôt c√°ch r·∫•t hi·ªáu qu·∫£ nh∆∞ l√† <code>defer</code> ho·∫∑c <code>channel</code>,...</p>
<div class='other-tags'><b>Tags:</b> <a class='topic-tag' href='https://huytd.github.io/tags/gpu.html'>gpu</a><a class='topic-tag' href='https://huytd.github.io/tags/golang.html'>golang</a><a class='topic-tag' href='https://huytd.github.io/tags/algorithm.html'>algorithm</a><a class='topic-tag' href='https://huytd.github.io/tags/math.html'>math</a></div>
                <div class="copyright">
                B·∫°n ƒë∆∞·ª£c t√πy √Ω b·∫•m like, tr√≠ch d·∫´n ho·∫∑c copy, post l·∫°i, nh∆∞ng vui l√≤ng ghi r√µ ngu·ªìn v√† t√°c gi·∫£ v√† kh√¥ng l√†m thay ƒë·ªïi n·ªôi dung b√†i vi·∫øt. N·∫øu kh√¥ng l√†m v·∫≠y, m√¨nh hy v·ªçng t·ª´ nay v·ªÅ sau b·∫°n s·∫Ω lu√¥n c·∫£m th·∫•y c·∫Øn r·ª©t l∆∞∆°ng t√¢m, ƒÉn kh√¥ng ngon, ng·ªß kh√¥ng y√™n. üòÜ
                </div>
                <div class="fb-like" data-href="http://huytd.github.io/posts/go-opencl.html" data-layout="standard" data-action="like" data-show-faces="true" data-share="true"></div>
                <div id="disqus_thread"></div>
                <script>
                /**
                * RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
                * LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
                */
                /*
                var disqus_config = function () {
                this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
                this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
                };
                */
                (function() { // DON'T EDIT BELOW THIS LINE
                var d = document, s = d.createElement('script');

                s.src = '//huysblog.disqus.com/embed.js';

                s.setAttribute('data-timestamp', +new Date());
                (d.head || d.body).appendChild(s);
                })();
                </script>
                <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
            </div>
        </div>
	    <div class="footer">
            <p>Created with <a href="http://github.com/huytd/azeroth-js">azeroth.js</a></p>
            <div class="social">
                <a target="_blank" href="http://facebook.com/kingbazoka"><i class="icon-facebook-squared"></i></a>
                <a target="_blank" href="http://twitter.com/huydotnet"><i class="icon-twitter-squared"></i></a>
                <a target="_blank" href="http://github.com/huytd"><i class="icon-github-squared"></i></a>
                <a target="_blank" href="https://thefullsnack.com"><i class="icon-emo-coffee"></i></a>
            </div>
        </div>
        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-71353335-1', 'auto');
          ga('send', 'pageview');
        </script>
        <script>
          window.fbAsyncInit = function() {
            FB.init({
              appId      : '462066520669072',
              xfbml      : true,
              version    : 'v2.6'
            });

            FB.Event.subscribe('edge.create', function(url) {
              ga('send', 'social', 'facebook', 'like', url);
            });
          };

          (function(d, s, id){
             var js, fjs = d.getElementsByTagName(s)[0];
             if (d.getElementById(id)) {return;}
             js = d.createElement(s); js.id = id;
             js.src = "//connect.facebook.net/en_US/sdk.js";
             fjs.parentNode.insertBefore(js, fjs);
           }(document, 'script', 'facebook-jssdk'));
        </script>
        <script id="dsq-count-scr" src="//huysblog.disqus.com/count.js" async></script>
        <script type="text/javascript" async src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script>
        <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
          tex2jax: {
            inlineMath: [['$','$'], ['\\(','\\)']],
            skipTags: ["script","noscript","style","textarea"]
          }
        });
        </script>
    </body>
</html>
