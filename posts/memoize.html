<html>
    <head>
        <title> KÄ© thuáº­t Memoize cáº£i thiá»‡n performance | Huy's Blog</title>
        <meta charset="utf-8">
        <meta http-equiv="content-type" content="text/html;"><meta name=viewport content="initial-scale=1.0 maximum-scale=1.0">
        
        <link href="../css/inconsolata.css" rel="stylesheet" type="text/css">
        <link href="../css/theme.css" rel="stylesheet" type="text/css">
        <link rel="stylesheet" href="../css/highlight/tomorrow.css">
        <link rel="stylesheet" href="../css/fontello.css">
        <script src="../js/highlight.pack.js"></script>
        <script>
        hljs.initHighlightingOnLoad();
        </script>
    </head>
    <body>
        <div class="header">
            <a href="/"><i class="icon icon-emo-coffee"></i> Huy's Blog</a>
        </div>
        <div class="container">
            <div class="main">
                <h1 id="k-thu-t-memoize-c-i-thi-n-performance">KÄ© thuáº­t Memoize cáº£i thiá»‡n performance</h1>
<div style="text-align: right">
<em><strong>Published:</strong> 23/03/2017 17:51</em>
</div>

<p>Memoize lÃ  má»™t kÄ© thuáº­t cache láº¡i giÃ¡ trá»‹ tráº£ vá» cá»§a cÃ¡c hÃ m dá»±a trÃªn tham sá»‘ truyá»n vÃ o nÃ³.</p>
<p>KÄ© thuáº­t nÃ y cÃ³ thá»ƒ Ã¡p dá»¥ng trÃªn má»i ngÃ´n ngá»¯ láº­p trÃ¬nh, trong bÃ i viáº¿t nÃ y mÃ¬nh chá»‰ láº¥y JavaScript ra lÃ m vÃ­ dá»¥.</p>
<h2 id="-t-v-n-b-i-to-n-t-m-s-fibonacci">Äáº·t váº¥n Ä‘á»: BÃ i toÃ¡n tÃ¬m sá»‘ Fibonacci</h2>
<p>Äá»‘i vá»›i bÃ i toÃ¡n tÃ¬m sá»‘ Fibonacci, chÃºng ta Ä‘á»u biáº¿t thuáº­t toÃ¡n Ä‘Æ¡n giáº£n nháº¥t Ä‘á»ƒ implement nÃ³ lÃ  sá»­ dá»¥ng Ä‘á»‡ quy:</p>
<pre class="math">$
F_{n}=F_{n-1}+F_{n-2}
$</pre>

<p>Hay diá»…n giáº£i báº±ng code nhÆ° sau:</p>
<pre><code>const fibo = (n) =&gt; {
  if (n === 0) return 0;
  if (n === 1) return 1;
  return fibo(n - 1) + fibo(n - 2);
}
</code></pre><p>NhÆ°á»£c Ä‘iá»ƒm cá»§a giáº£i phÃ¡p trÃªn ráº¥t rÃµ rÃ ng, Ä‘Ã³ lÃ  thá»i gian tÃ­nh toÃ¡n. Äá»‘i vá»›i má»—i láº§n tÃ­nh toÃ¡n, hÃ m <code>fibo</code> pháº£i thá»±c hiá»‡n tÃ­nh toÃ¡n láº¡i tá»« Ä‘áº§u (tá»« <code>n = 0</code>) Ä‘áº¿n <code>n</code>. Trong quÃ¡ trÃ¬nh Ä‘Ã³ má»™t giÃ¡ trá»‹ <code>fibo(n)</code> sáº½ bá»‹ tÃ­nh Ä‘i tÃ­nh láº¡i liÃªn tá»¥c, má»™t sá»± lÃ£ng phÃ­ khÃ´ng há» nhá».</p>
<p>Thá»i gian cháº¡y cá»§a thuáº­t toÃ¡n trÃªn cho káº¿t quáº£ <code>fibo(50)</code>:</p>
<pre><code>// fibo(50);
âœ  time node fibo.js

193.97s user 
0.56s   system 
99%     cpu 
3:15.24 total
</code></pre><p>VÃ  nhÆ° ta Ä‘Ã£ nháº­n tháº¥y, thÃ¬ pháº§n lá»›n thá»i gian tiÃªu tá»‘n vÃ o viá»‡c tÃ­nh Ä‘i tÃ­nh láº¡i cÃ¡c giÃ¡ trá»‹ trÃ¹ng láº·p, váº­y Ä‘á»ƒ cáº£i thiá»‡n, ta cáº§n tÃ¬m má»™t cÃ¡ch nÃ o Ä‘Ã³ Ä‘á»ƒ lÆ°u láº¡i giÃ¡ trá»‹ cá»§a tá»«ng phÃ©p tÃ­nh <code>fibo(n)</code>, vÃ  trÃ¡nh viá»‡c tÃ­nh láº¡i tá»« Ä‘áº§u má»—i khi cháº¡y. CÃ¡ch nÃ y gá»i lÃ  <strong>caching</strong>.</p>
<p>VÃ¬ Ä‘á»‘i vá»›i má»—i sá»‘ <code>n</code> báº¥t kÃ¬, ta luÃ´n luÃ´n chá»‰ cÃ³ duy nháº¥t má»™t giÃ¡ trá»‹ sau khi tÃ­nh toÃ¡n vá»›i hÃ m <code>fibo(n)</code>. Váº­y nÃªn ta cÃ³ thá»ƒ táº¡o ra má»™t máº£ng tÃªn lÃ  <code>cache</code> Ä‘á»ƒ lÆ°u láº¡i cÃ¡c giÃ¡ trá»‹ <code>fibo(n)</code> Ä‘Ã£ tÃ­nh toÃ¡n, á»Ÿ láº§n cháº¡y tiáº¿p theo, chá»‰ viá»‡c láº¥y nÃ³ ra vÃ  sá»­ dá»¥ng, khÃ´ng cáº§n pháº£i tÃ­nh láº¡i.</p>
<pre><code>const cache = [];

const fibo = (n) =&gt; {
  if (n === 0) 
    cache[n] = 0;
  else if (n === 1) 
    cache[n] = 1;
  else 
    cache[n] = cache[n] || (fibo(n - 1) + fibo(n - 2));
  return cache[n];
}
</code></pre><p>Káº¿t quáº£ thá»i gian cháº¡y <code>fibo(50)</code> Ä‘Æ°á»£c cáº£i thiá»‡n Ä‘Ã¡ng ká»ƒ:</p>
<pre><code>// fibo(50);
âœ  time node fibo.js

0.05s user 
0.02s system 
98%   cpu 
0.072 total
</code></pre><h2 id="memoize">Memoize</h2>
<p>VÃ­ dá»¥ trÃªn cho chÃºng ta tháº¥y Ä‘Æ°á»£c táº§m quan trá»ng cá»§a viá»‡c cache trong viá»‡c cáº£i thiá»‡n tá»‘c Ä‘á»™ xá»­ lÃ½ cá»§a má»™t á»©ng dá»¥ng.</p>
<p>Tuy nhiÃªn, cá»© pháº£i táº¡o má»™t biáº¿n toÃ n cá»¥c <code>cache</code> má»™t cÃ¡ch thá»§ cÃ´ng nhÆ° váº­y khÃ´ng pháº£i lÃ  má»™t giáº£i phÃ¡p hay, chÆ°a ká»ƒ Ä‘áº¿n viá»‡c cáº§n cache nhiá»u thá»© trong má»™t á»©ng dá»¥ng, chÃºng ta cáº§n má»™t phÆ°Æ¡ng phÃ¡p tá»•ng quÃ¡t hÆ¡n, vÃ  hiá»‡u quáº£ hÆ¡n. ÄÃ³ lÃ  memoize.</p>
<p>Memoize khÃ¡c vá»›i cÃ¡c kÄ© thuáº­t cache thÃ´ng thÆ°á»ng á»Ÿ chá»—: <strong>NÃ³ Ä‘Æ°á»£c dÃ¹ng Ä‘á»ƒ cache giÃ¡ trá»‹ tráº£ vá» cá»§a má»™t hÃ m, vÃ  cache Ä‘Æ°á»£c táº¡o ra dá»±a trÃªn tham sá»‘ cá»§a hÃ m Ä‘Ã³.</strong></p>
<p>Sau Ä‘Ã¢y lÃ  má»™t cÃ¡ch implement Ä‘Æ¡n giáº£n cho hÃ m <code>memoize</code>:</p>
<pre><code>const memoize = (func) =&gt; {
  let cache = {};
  let that = this;
  return (...args) =&gt; {
    let key = JSON.stringify(args);
    if(cache[key]) {
      return cache[key];
    }
    else {
      let val = func.apply(that, args);
      cache[key] = val;
      return val;
    }
  }
};
</code></pre><p>HÃ m <code>memozie</code> nháº­n vÃ o tham sá»‘ lÃ  má»™t hÃ m, táº¡o cache dá»±a trÃªn cÃ¡c tham sá»‘ truyá»n vÃ o cá»§a hÃ m Ä‘Ã³. Khi Ä‘Æ°á»£c gá»i thÃ¬ nÃ³ sáº½ tráº£ vá» giÃ¡ trá»‹ Ä‘Æ°á»£c cache náº¿u cÃ³, náº¿u chÆ°a cÃ³ giÃ¡ trá»‹ cache thÃ¬ cháº¡y chÃ­nh hÃ m Ä‘Æ°á»£c truyá»n vÃ o vÃ  lÆ°u láº¡i giÃ¡ trá»‹ tráº£ vá».</p>
<p>Cá»±c kÃ¬ Ä‘Æ¡n giáº£n Ä‘Ãºng khÃ´ng? Giá» chÃºng ta thá»­ implement láº¡i hÃ m <code>fibo</code> á»Ÿ Ä‘áº§u bÃ i dÃ¹ng <code>memoize</code>:</p>
<pre><code>const memfibo = memoize((n) =&gt; {
  if (n === 0) return 0;
  if (n === 1) return 1;
  return memfibo(n - 1) + memfibo(n - 2);
});
</code></pre><p>Pháº§n logic váº«n Ä‘Æ°á»£c giá»¯ nguyÃªn so vá»›i cÃ¡ch implement Ä‘áº§u tiÃªn, nhÆ°ng váº«n sá»­ dá»¥ng Ä‘Æ°á»£c cache, Ä‘Ã³ lÃ  Æ°u Ä‘iá»ƒm cá»§a viá»‡c dÃ¹ng <code>memoize</code>.</p>
<p>Cháº¡y thá»­ hÃ m <code>memfibo</code> vá»«a táº¡o vá»›i tham sá»‘ <code>n = 100</code> luÃ´n coi sao:</p>
<pre><code>// memfibo(100);
âœ  time node fibo.js

0.06s user 
0.02s system 
97%   cpu 
0.077 total
</code></pre><p>QuÃ¡ xá»‹n :D</p>
<h2 id="c-c-implement-kh-c-c-a-memoize">CÃ¡c implement khÃ¡c cá»§a memoize</h2>
<p>Trong thá»±c táº¿, cÃ³ thá»ƒ báº¡n sáº½ khÃ´ng Ä‘á»§ tá»± tin Ä‘á»ƒ sá»­ dá»¥ng hÃ m <code>memoize</code> do chÃ­nh mÃ¬nh implement, hoáº·c team/sáº¿p khÃ´ng tin tÆ°á»ng báº¡n, ok, khÃ´ng sao, máº·c dÃ¹ bá»‹ tá»•n thÆ°ong nhÆ°ng khÃ´ng nÃªn vÃ¬ tháº¿ mÃ  náº£n.</p>
<p>ChÃºng ta cÃ³ thá»ƒ sá»­ dá»¥ng má»™t vÃ i implement khÃ¡c nhÆ°:</p>
<ul>
<li>Lodash Memoize (<a href="https://npmjs.com/package/lodash.memoize">https://npmjs.com/package/lodash.memoize</a>)</li>
<li>Fast-memoize (<a href="https://npmjs.com/package/fast-memoize">https://npmjs.com/package/fast-memoize</a>)</li>
</ul>
<p>NgoÃ i ra, cÃ¡c báº¡n cÃ³ thá»ƒ tham kháº£o thÃªm bÃ i viáº¿t <a href="https://community.risingstack.com/the-worlds-fastest-javascript-memoization-library/">How I wrote the fastest JavaScript memoization library</a> Ä‘á»ƒ cÃ³ cÃ¡i nhÃ¬n sÃ¢u hÆ¡n vá» cÃ¡c kÄ© thuáº­t implement/tá»‘i Æ°u hÃ³a cho memoize.</p>
<h2 id="bonus-s-d-ng-memoize-trong-angular-filter">Bonus: Sá»­ dá»¥ng memoize trong Angular filter</h2>
<p>Má»™t trÆ°Ã²ng há»£p mÃ  báº¡n cÃ³ thá»ƒ sá»­ dá»¥ng memoize khÃ¡ lÃ  hiá»‡u quáº£ Ä‘Ã³ lÃ  khi implement má»™t <code>filter</code> trong Angular. VÃ­ dá»¥:</p>
<pre><code>angular.module(&#39;app&#39;).filter(&#39;evenNumbers&#39;, function() {
  return function(items) {
    return items.reduce(function(result, item) {
      return (item % 2 === 0);
    }, []);
  };
});
</code></pre><p>Filter trÃªn nháº­n vÃ o má»™t máº£ng vÃ  tráº£ vá» má»™t máº£ng má»›i, nhÆ°ng khi sá»­ dá»¥ng filter trÃªn báº¡n sáº½ gáº·p lá»—i:</p>
<pre><code>Error: [$rootScope:infdig] 10 $digest() iterations reached. Aborting!
</code></pre><p>NguyÃªn nhÃ¢n cá»§a lá»—i trÃªn lÃ  vÃ¬: hÃ m <code>reduce</code> tráº£ vá» má»™t máº£ng má»›i má»—i láº§n báº¡n cháº¡y filter <code>evenNumbers</code>, khiáº¿n cho Angular &quot;hiá»ƒu láº§m&quot; káº¿t quáº£ tráº£ vá» Ä‘Ã£ Ä‘Æ°á»c thay Ä‘á»•i vÃ  nÃ³ pháº£i cháº¡y má»™t digest cycle má»›i Ä‘á»ƒ kiá»ƒm tra, vÃ  viá»‡c cháº¡y nÃ y xáº£y ra liÃªn tá»¥c.</p>
<p>Khi gáº·p nhá»¯ng trÆ°Ã²ng há»£p nhÆ° váº­y, báº£n chá»‰ cáº§n Ä‘áº·t hÃ m filter vÃ o bÃªn trong <code>memoize</code> Ä‘á»ƒ cache láº¡i giÃ¡ trá»‹ tráº£ vá» lÃ  xong:</p>
<pre><code>angular.module(&#39;app&#39;).filter(&#39;evenNumbers&#39;, function() {
  return memoize(function(items) {
    return items.reduce(function(result, item) {
      return (item % 2 === 0);
    }, []);
  });
});
</code></pre><h2 id="l-i-cu-i-x-n-nh-ng-d-ng-nhi-u-th-h-t-x-n">Lá»i cuá»‘i: Ä‘á»“ xá»‹n nhÆ°ng dÃ¹ng nhiá»u thÃ¬ háº¿t xá»‹n</h2>
<p>CÃ³ má»™t trÆ°Ã²ng há»£p mÃ  dÃ¹ cÃ³ sá»­ dá»¥ng memoize thÃ¬ cÅ©ng vÃ´ dá»¥ng, Ä‘Ã³ lÃ  khi dá»¯ liá»‡u tráº£ vá» cá»§a má»™t hÃ m nÃ³ thay Ä‘á»•i khÃ´ng phá»¥ thuá»™c vÃ o tham sá»‘ truyá»n vÃ o cá»§a hÃ m Ä‘Ã³. VÃ­ dá»¥ dá»¯ liá»‡u tracking dáº¡ng time series, hay giÃ¡ chá»©ng khoÃ¡n, hay danh sÃ¡ch status trÃªn tÆ°Ã²ng nhÃ  Ä‘á»©a báº¡n thÃ­ch trÃªn Facebook cháº³n háº¡n.</p>
<p>VÃ  thÃªm ná»¯a, vÃ¬ memoize cÅ©ng lÃ  caching, tá»©c lÃ  dá»¯ liá»‡u tÃ­nh toÃ¡n xong Ä‘Æ°á»£c lÆ°u láº¡i vÃ  náº±m Ä‘Ã³ luÃ´n, khÃ´ng máº¥t Ä‘i Ä‘Ã¢u cáº£, cho nÃªn báº¡n pháº£i nghÄ© tá»›i váº¥n Ä‘á» khi app cháº¡y trong má»™t khoáº£n thá»i gian dÃ i, thÃ¬ dung lÆ°á»ng bá»™ nhá»› cÅ©ng vÃ¬ tháº¿ mÃ  tÄƒng lÃªn. Cho nÃªn cáº§n pháº£i giáº£i phÃ³ng bá»™ nhá»› cache cá»§a hÃ m memoize sau má»™t khoáº£n thá»i gian nháº¥t Ä‘á»‹nh, náº¿u khÃ´ng sáº½ dáº«n tá»›i trÃ n bá»™ nhá»› hoáº·c memleak.</p>
<p>VÃ¬ sá»­ dá»¥ng memoize tá»©c lÃ  báº¡n Ä‘ang Ä‘Ã¡nh Ä‘á»•i memory Ä‘á»ƒ láº¥y tá»‘c Ä‘á»™, chá»© khÃ´ng cÃ³ cÃ¡i gÃ¬ lÃ  free cáº£, nÃªn náº¿u biáº¿t chá»«ng má»±c vÃ  dÃ¹ng Ä‘Ãºng lÃºc Ä‘Ãºng chá»— thÃ¬ sáº½ Ä‘em láº¡i hiá»‡u quáº£ cao, cÃ²n ngÆ°á»£c láº¡i, láº¡m dá»¥ng quÃ¡ má»©c thÃ¬ háº­u quáº£ sáº½ khÃ³ lÆ°á»ng. Cho nÃªn gÃ¬ gÃ¬ thÃ¬ cÅ©ng pháº£i hiá»ƒu Ä‘á»ƒ xÃ i nhau cho tá»‘t hÆ¡n, nhÃ© :D </p>
<div class='other-tags'><b>Tags:</b> <a class='topic-tag' href='https://huytd.github.io/tags/javascript.html'>javascript</a><a class='topic-tag' href='https://huytd.github.io/tags/memoize.html'>memoize</a><a class='topic-tag' href='https://huytd.github.io/tags/performance.html'>performance</a><a class='topic-tag' href='https://huytd.github.io/tags/algorithm.html'>algorithm</a></div>
                <div class="copyright">
                Báº¡n Ä‘Æ°á»£c tÃ¹y Ã½ báº¥m like, trÃ­ch dáº«n hoáº·c copy, post láº¡i, nhÆ°ng vui lÃ²ng ghi rÃµ nguá»“n vÃ  tÃ¡c giáº£ vÃ  khÃ´ng lÃ m thay Ä‘á»•i ná»™i dung bÃ i viáº¿t. Náº¿u khÃ´ng lÃ m váº­y, mÃ¬nh hy vá»ng tá»« nay vá» sau báº¡n sáº½ luÃ´n cáº£m tháº¥y cáº¯n rá»©t lÆ°Æ¡ng tÃ¢m, Äƒn khÃ´ng ngon, ngá»§ khÃ´ng yÃªn. ğŸ˜†
                </div>
            </div>
        </div>
	    <div class="footer">
            <p>Created with <a href="http://github.com/huytd/azeroth-js">azeroth.js</a></p>
            <div class="social">
                <a target="_blank" href="http://facebook.com/kingbazoka"><i class="icon-facebook-squared"></i></a>
                <a target="_blank" href="http://twitter.com/huydotnet"><i class="icon-twitter-squared"></i></a>
                <a target="_blank" href="http://github.com/huytd"><i class="icon-github-squared"></i></a>
                <a target="_blank" href="https://thefullsnack.com"><i class="icon-emo-coffee"></i></a>
            </div>
        </div>
        <script type="text/javascript" async src="https://cdn.rawgit.com/mathjax/MathJax/2.7.0/MathJax.js"></script>
        <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
          tex2jax: {
            inlineMath: [['$','$'], ['\\(','\\)']],
            skipTags: ["script","noscript","style","textarea"]
          }
        });
        </script>
    </body>
</html>
