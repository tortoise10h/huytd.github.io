<html>
    <head>
        <title> Kƒ© thu·∫≠t Memoize c·∫£i thi·ªán performance | Huy's Blog</title>
        <meta charset="utf-8">
        <meta http-equiv="content-type" content="text/html;"><meta name=viewport content="initial-scale=1.0 maximum-scale=1.0">
        
        <link href="../css/theme.css" rel="stylesheet" type="text/css">
        <link rel="stylesheet" href="../css/highlight/tomorrow.css">
        <link rel="stylesheet" href="../css/fontello.css">
        <script src="../js/highlight.pack.js"></script>
        <script>
        hljs.initHighlightingOnLoad();
        </script>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    </head>
    <body>
        <div class="header">
            <a href="/"><i class="icon icon-emo-coffee"></i> Huy's Blog</a>
        </div>
        <div class="container">
            <div class="main">
                <h1 id="k-thu-t-memoize-c-i-thi-n-performance">Kƒ© thu·∫≠t Memoize c·∫£i thi·ªán performance</h1>
<div style="text-align: right">
<em><strong>Published:</strong> 23/03/2017 17:51</em>
</div>

<p>Memoize l√† m·ªôt kƒ© thu·∫≠t cache l·∫°i gi√° tr·ªã tr·∫£ v·ªÅ c·ªßa c√°c h√†m d·ª±a tr√™n tham s·ªë truy·ªÅn v√†o n√≥.</p>
<p>Kƒ© thu·∫≠t n√†y c√≥ th·ªÉ √°p d·ª•ng tr√™n m·ªçi ng√¥n ng·ªØ l·∫≠p tr√¨nh, trong b√†i vi·∫øt n√†y m√¨nh ch·ªâ l·∫•y JavaScript ra l√†m v√≠ d·ª•.</p>
<h2 id="-t-v-n-b-i-to-n-t-m-s-fibonacci">ƒê·∫∑t v·∫•n ƒë·ªÅ: B√†i to√°n t√¨m s·ªë Fibonacci</h2>
<p>ƒê·ªëi v·ªõi b√†i to√°n t√¨m s·ªë Fibonacci, ch√∫ng ta ƒë·ªÅu bi·∫øt thu·∫≠t to√°n ƒë∆°n gi·∫£n nh·∫•t ƒë·ªÉ implement n√≥ l√† s·ª≠ d·ª•ng ƒë·ªá quy:</p>
<pre class="math">$
F_{n}=F_{n-1}+F_{n-2}
$</pre>

<p>Hay di·ªÖn gi·∫£i b·∫±ng code nh∆∞ sau:</p>
<pre><code>const fibo = (n) =&gt; {
  if (n === 0) return 0;
  if (n === 1) return 1;
  return fibo(n - 1) + fibo(n - 2);
}
</code></pre><p>Nh∆∞·ª£c ƒëi·ªÉm c·ªßa gi·∫£i ph√°p tr√™n r·∫•t r√µ r√†ng, ƒë√≥ l√† th·ªùi gian t√≠nh to√°n. ƒê·ªëi v·ªõi m·ªói l·∫ßn t√≠nh to√°n, h√†m <code>fibo</code> ph·∫£i th·ª±c hi·ªán t√≠nh to√°n l·∫°i t·ª´ ƒë·∫ßu (t·ª´ <code>n = 0</code>) ƒë·∫øn <code>n</code>. Trong qu√° tr√¨nh ƒë√≥ m·ªôt gi√° tr·ªã <code>fibo(n)</code> s·∫Ω b·ªã t√≠nh ƒëi t√≠nh l·∫°i li√™n t·ª•c, m·ªôt s·ª± l√£ng ph√≠ kh√¥ng h·ªÅ nh·ªè.</p>
<p>Th·ªùi gian ch·∫°y c·ªßa thu·∫≠t to√°n tr√™n cho k·∫øt qu·∫£ <code>fibo(50)</code>:</p>
<pre><code>// fibo(50);
‚ûú  time node fibo.js

193.97s user 
0.56s   system 
99%     cpu 
3:15.24 total
</code></pre><p>V√† nh∆∞ ta ƒë√£ nh·∫≠n th·∫•y, th√¨ ph·∫ßn l·ªõn th·ªùi gian ti√™u t·ªën v√†o vi·ªác t√≠nh ƒëi t√≠nh l·∫°i c√°c gi√° tr·ªã tr√πng l·∫∑p, v·∫≠y ƒë·ªÉ c·∫£i thi·ªán, ta c·∫ßn t√¨m m·ªôt c√°ch n√†o ƒë√≥ ƒë·ªÉ l∆∞u l·∫°i gi√° tr·ªã c·ªßa t·ª´ng ph√©p t√≠nh <code>fibo(n)</code>, v√† tr√°nh vi·ªác t√≠nh l·∫°i t·ª´ ƒë·∫ßu m·ªói khi ch·∫°y. C√°ch n√†y g·ªçi l√† <strong>caching</strong>.</p>
<p>V√¨ ƒë·ªëi v·ªõi m·ªói s·ªë <code>n</code> b·∫•t k√¨, ta lu√¥n lu√¥n ch·ªâ c√≥ duy nh·∫•t m·ªôt gi√° tr·ªã sau khi t√≠nh to√°n v·ªõi h√†m <code>fibo(n)</code>. V·∫≠y n√™n ta c√≥ th·ªÉ t·∫°o ra m·ªôt m·∫£ng t√™n l√† <code>cache</code> ƒë·ªÉ l∆∞u l·∫°i c√°c gi√° tr·ªã <code>fibo(n)</code> ƒë√£ t√≠nh to√°n, ·ªü l·∫ßn ch·∫°y ti·∫øp theo, ch·ªâ vi·ªác l·∫•y n√≥ ra v√† s·ª≠ d·ª•ng, kh√¥ng c·∫ßn ph·∫£i t√≠nh l·∫°i.</p>
<pre><code>const cache = [];

const fibo = (n) =&gt; {
  if (n === 0) 
    cache[n] = 0;
  else if (n === 1) 
    cache[n] = 1;
  else 
    cache[n] = cache[n] || (fibo(n - 1) + fibo(n - 2));
  return cache[n];
}
</code></pre><p>K·∫øt qu·∫£ th·ªùi gian ch·∫°y <code>fibo(50)</code> ƒë∆∞·ª£c c·∫£i thi·ªán ƒë√°ng k·ªÉ:</p>
<pre><code>// fibo(50);
‚ûú  time node fibo.js

0.05s user 
0.02s system 
98%   cpu 
0.072 total
</code></pre><h2 id="memoize">Memoize</h2>
<p>V√≠ d·ª• tr√™n cho ch√∫ng ta th·∫•y ƒë∆∞·ª£c t·∫ßm quan tr·ªçng c·ªßa vi·ªác cache trong vi·ªác c·∫£i thi·ªán t·ªëc ƒë·ªô x·ª≠ l√Ω c·ªßa m·ªôt ·ª©ng d·ª•ng.</p>
<p>Tuy nhi√™n, c·ª© ph·∫£i t·∫°o m·ªôt bi·∫øn to√†n c·ª•c <code>cache</code> m·ªôt c√°ch th·ªß c√¥ng nh∆∞ v·∫≠y kh√¥ng ph·∫£i l√† m·ªôt gi·∫£i ph√°p hay, ch∆∞a k·ªÉ ƒë·∫øn vi·ªác c·∫ßn cache nhi·ªÅu th·ª© trong m·ªôt ·ª©ng d·ª•ng, ch√∫ng ta c·∫ßn m·ªôt ph∆∞∆°ng ph√°p t·ªïng qu√°t h∆°n, v√† hi·ªáu qu·∫£ h∆°n. ƒê√≥ l√† memoize.</p>
<p>Memoize kh√°c v·ªõi c√°c kƒ© thu·∫≠t cache th√¥ng th∆∞·ªùng ·ªü ch·ªó: <strong>N√≥ ƒë∆∞·ª£c d√πng ƒë·ªÉ cache gi√° tr·ªã tr·∫£ v·ªÅ c·ªßa m·ªôt h√†m, v√† cache ƒë∆∞·ª£c t·∫°o ra d·ª±a tr√™n tham s·ªë c·ªßa h√†m ƒë√≥.</strong></p>
<p>Sau ƒë√¢y l√† m·ªôt c√°ch implement ƒë∆°n gi·∫£n cho h√†m <code>memoize</code>:</p>
<pre><code>const memoize = (func) =&gt; {
  let cache = {};
  let that = this;
  return (...args) =&gt; {
    let key = JSON.stringify(args);
    if(cache[key]) {
      return cache[key];
    }
    else {
      let val = func.apply(that, args);
      cache[key] = val;
      return val;
    }
  }
};
</code></pre><p>H√†m <code>memozie</code> nh·∫≠n v√†o tham s·ªë l√† m·ªôt h√†m, t·∫°o cache d·ª±a tr√™n c√°c tham s·ªë truy·ªÅn v√†o c·ªßa h√†m ƒë√≥. Khi ƒë∆∞·ª£c g·ªçi th√¨ n√≥ s·∫Ω tr·∫£ v·ªÅ gi√° tr·ªã ƒë∆∞·ª£c cache n·∫øu c√≥, n·∫øu ch∆∞a c√≥ gi√° tr·ªã cache th√¨ ch·∫°y ch√≠nh h√†m ƒë∆∞·ª£c truy·ªÅn v√†o v√† l∆∞u l·∫°i gi√° tr·ªã tr·∫£ v·ªÅ.</p>
<p>C·ª±c k√¨ ƒë∆°n gi·∫£n ƒë√∫ng kh√¥ng? Gi·ªù ch√∫ng ta th·ª≠ implement l·∫°i h√†m <code>fibo</code> ·ªü ƒë·∫ßu b√†i d√πng <code>memoize</code>:</p>
<pre><code>const memfibo = memoize((n) =&gt; {
  if (n === 0) return 0;
  if (n === 1) return 1;
  return memfibo(n - 1) + memfibo(n - 2);
});
</code></pre><p>Ph·∫ßn logic v·∫´n ƒë∆∞·ª£c gi·ªØ nguy√™n so v·ªõi c√°ch implement ƒë·∫ßu ti√™n, nh∆∞ng v·∫´n s·ª≠ d·ª•ng ƒë∆∞·ª£c cache, ƒë√≥ l√† ∆∞u ƒëi·ªÉm c·ªßa vi·ªác d√πng <code>memoize</code>.</p>
<p>Ch·∫°y th·ª≠ h√†m <code>memfibo</code> v·ª´a t·∫°o v·ªõi tham s·ªë <code>n = 100</code> lu√¥n coi sao:</p>
<pre><code>// memfibo(100);
‚ûú  time node fibo.js

0.06s user 
0.02s system 
97%   cpu 
0.077 total
</code></pre><p>Qu√° x·ªãn :D</p>
<h2 id="c-c-implement-kh-c-c-a-memoize">C√°c implement kh√°c c·ªßa memoize</h2>
<p>Trong th·ª±c t·∫ø, c√≥ th·ªÉ b·∫°n s·∫Ω kh√¥ng ƒë·ªß t·ª± tin ƒë·ªÉ s·ª≠ d·ª•ng h√†m <code>memoize</code> do ch√≠nh m√¨nh implement, ho·∫∑c team/s·∫øp kh√¥ng tin t∆∞·ªèng b·∫°n, ok, kh√¥ng sao, m·∫∑c d√π b·ªã t·ªïn th∆∞ong nh∆∞ng kh√¥ng n√™n v√¨ th·∫ø m√† n·∫£n.</p>
<p>Ch√∫ng ta c√≥ th·ªÉ s·ª≠ d·ª•ng m·ªôt v√†i implement kh√°c nh∆∞:</p>
<ul>
<li>Lodash Memoize (<a href="https://npmjs.com/package/lodash.memoize">https://npmjs.com/package/lodash.memoize</a>)</li>
<li>Fast-memoize (<a href="https://npmjs.com/package/fast-memoize">https://npmjs.com/package/fast-memoize</a>)</li>
</ul>
<p>Ngo√†i ra, c√°c b·∫°n c√≥ th·ªÉ tham kh·∫£o th√™m b√†i vi·∫øt <a href="https://community.risingstack.com/the-worlds-fastest-javascript-memoization-library/">How I wrote the fastest JavaScript memoization library</a> ƒë·ªÉ c√≥ c√°i nh√¨n s√¢u h∆°n v·ªÅ c√°c kƒ© thu·∫≠t implement/t·ªëi ∆∞u h√≥a cho memoize.</p>
<h2 id="bonus-s-d-ng-memoize-trong-angular-filter">Bonus: S·ª≠ d·ª•ng memoize trong Angular filter</h2>
<p>M·ªôt tr∆∞√≤ng h·ª£p m√† b·∫°n c√≥ th·ªÉ s·ª≠ d·ª•ng memoize kh√° l√† hi·ªáu qu·∫£ ƒë√≥ l√† khi implement m·ªôt <code>filter</code> trong Angular. V√≠ d·ª•:</p>
<pre><code>angular.module(&#39;app&#39;).filter(&#39;evenNumbers&#39;, function() {
  return function(items) {
    return items.reduce(function(result, item) {
      return (item % 2 === 0);
    }, []);
  };
});
</code></pre><p>Filter tr√™n nh·∫≠n v√†o m·ªôt m·∫£ng v√† tr·∫£ v·ªÅ m·ªôt m·∫£ng m·ªõi, nh∆∞ng khi s·ª≠ d·ª•ng filter tr√™n b·∫°n s·∫Ω g·∫∑p l·ªói:</p>
<pre><code>Error: [$rootScope:infdig] 10 $digest() iterations reached. Aborting!
</code></pre><p>Nguy√™n nh√¢n c·ªßa l·ªói tr√™n l√† v√¨: h√†m <code>reduce</code> tr·∫£ v·ªÅ m·ªôt m·∫£ng m·ªõi m·ªói l·∫ßn b·∫°n ch·∫°y filter <code>evenNumbers</code>, khi·∫øn cho Angular &quot;hi·ªÉu l·∫ßm&quot; k·∫øt qu·∫£ tr·∫£ v·ªÅ ƒë√£ ƒë∆∞·ªçc thay ƒë·ªïi v√† n√≥ ph·∫£i ch·∫°y m·ªôt digest cycle m·ªõi ƒë·ªÉ ki·ªÉm tra, v√† vi·ªác ch·∫°y n√†y x·∫£y ra li√™n t·ª•c.</p>
<p>Khi g·∫∑p nh·ªØng tr∆∞√≤ng h·ª£p nh∆∞ v·∫≠y, b·∫£n ch·ªâ c·∫ßn ƒë·∫∑t h√†m filter v√†o b√™n trong <code>memoize</code> ƒë·ªÉ cache l·∫°i gi√° tr·ªã tr·∫£ v·ªÅ l√† xong:</p>
<pre><code>angular.module(&#39;app&#39;).filter(&#39;evenNumbers&#39;, function() {
  return memoize(function(items) {
    return items.reduce(function(result, item) {
      return (item % 2 === 0);
    }, []);
  });
});
</code></pre><h2 id="l-i-cu-i-x-n-nh-ng-d-ng-nhi-u-th-h-t-x-n">L·ªùi cu·ªëi: ƒë·ªì x·ªãn nh∆∞ng d√πng nhi·ªÅu th√¨ h·∫øt x·ªãn</h2>
<p>C√≥ m·ªôt tr∆∞√≤ng h·ª£p m√† d√π c√≥ s·ª≠ d·ª•ng memoize th√¨ c≈©ng v√¥ d·ª•ng, ƒë√≥ l√† khi d·ªØ li·ªáu tr·∫£ v·ªÅ c·ªßa m·ªôt h√†m n√≥ thay ƒë·ªïi kh√¥ng ph·ª• thu·ªôc v√†o tham s·ªë truy·ªÅn v√†o c·ªßa h√†m ƒë√≥. V√≠ d·ª• d·ªØ li·ªáu tracking d·∫°ng time series, hay gi√° ch·ª©ng kho√°n, hay danh s√°ch status tr√™n t∆∞√≤ng nh√† ƒë·ª©a b·∫°n th√≠ch tr√™n Facebook ch·∫≥n h·∫°n.</p>
<p>V√† th√™m n·ªØa, v√¨ memoize c≈©ng l√† caching, t·ª©c l√† d·ªØ li·ªáu t√≠nh to√°n xong ƒë∆∞·ª£c l∆∞u l·∫°i v√† n·∫±m ƒë√≥ lu√¥n, kh√¥ng m·∫•t ƒëi ƒë√¢u c·∫£, cho n√™n b·∫°n ph·∫£i nghƒ© t·ªõi v·∫•n ƒë·ªÅ khi app ch·∫°y trong m·ªôt kho·∫£n th·ªùi gian d√†i, th√¨ dung l∆∞·ªçng b·ªô nh·ªõ c≈©ng v√¨ th·∫ø m√† tƒÉng l√™n. Cho n√™n c·∫ßn ph·∫£i gi·∫£i ph√≥ng b·ªô nh·ªõ cache c·ªßa h√†m memoize sau m·ªôt kho·∫£n th·ªùi gian nh·∫•t ƒë·ªãnh, n·∫øu kh√¥ng s·∫Ω d·∫´n t·ªõi tr√†n b·ªô nh·ªõ ho·∫∑c memleak.</p>
<p>V√¨ s·ª≠ d·ª•ng memoize t·ª©c l√† b·∫°n ƒëang ƒë√°nh ƒë·ªïi memory ƒë·ªÉ l·∫•y t·ªëc ƒë·ªô, ch·ª© kh√¥ng c√≥ c√°i g√¨ l√† free c·∫£, n√™n n·∫øu bi·∫øt ch·ª´ng m·ª±c v√† d√πng ƒë√∫ng l√∫c ƒë√∫ng ch·ªó th√¨ s·∫Ω ƒëem l·∫°i hi·ªáu qu·∫£ cao, c√≤n ng∆∞·ª£c l·∫°i, l·∫°m d·ª•ng qu√° m·ª©c th√¨ h·∫≠u qu·∫£ s·∫Ω kh√≥ l∆∞·ªùng. Cho n√™n g√¨ g√¨ th√¨ c≈©ng ph·∫£i hi·ªÉu ƒë·ªÉ x√†i nhau cho t·ªët h∆°n, nh√© :D </p>

                <div class="copyright">
                B·∫°n ƒë∆∞·ª£c t√πy √Ω b·∫•m like, tr√≠ch d·∫´n ho·∫∑c copy, post l·∫°i, nh∆∞ng vui l√≤ng ghi r√µ ngu·ªìn v√† t√°c gi·∫£ v√† kh√¥ng l√†m thay ƒë·ªïi n·ªôi dung b√†i vi·∫øt. N·∫øu kh√¥ng l√†m v·∫≠y, m√¨nh hy v·ªçng t·ª´ nay v·ªÅ sau b·∫°n s·∫Ω lu√¥n c·∫£m th·∫•y c·∫Øn r·ª©t l∆∞∆°ng t√¢m, ƒÉn kh√¥ng ngon, ng·ªß kh√¥ng y√™n. üòÜ
                </div>
                <div class="fb-like" data-href="http://huytd.github.io/posts/memoize.html" data-layout="standard" data-action="like" data-show-faces="true" data-share="true"></div>
                <div id="disqus_thread"></div>
                <script>
                /**
                * RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
                * LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
                */
                /*
                var disqus_config = function () {
                this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
                this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
                };
                */
                (function() { // DON'T EDIT BELOW THIS LINE
                var d = document, s = d.createElement('script');

                s.src = '//huysblog.disqus.com/embed.js';

                s.setAttribute('data-timestamp', +new Date());
                (d.head || d.body).appendChild(s);
                })();
                </script>
                <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
            </div>
        </div>
	    <div class="footer">
            <p>Created with <a href="http://github.com/huytd/azeroth-js">azeroth.js</a></p>
            <div class="social">
                <a target="_blank" href="http://facebook.com/kingbazoka"><i class="icon-facebook-squared"></i></a>
                <a target="_blank" href="http://twitter.com/huydotnet"><i class="icon-twitter-squared"></i></a>
                <a target="_blank" href="http://github.com/huytd"><i class="icon-github-squared"></i></a>
                <a target="_blank" href="https://thefullsnack.com"><i class="icon-emo-coffee"></i></a>
            </div>
        </div>
        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-71353335-1', 'auto');
          ga('send', 'pageview');
        </script>
        <script>
          window.fbAsyncInit = function() {
            FB.init({
              appId      : '462066520669072',
              xfbml      : true,
              version    : 'v2.6'
            });

            FB.Event.subscribe('edge.create', function(url) {
              ga('send', 'social', 'facebook', 'like', url);
            });
          };

          (function(d, s, id){
             var js, fjs = d.getElementsByTagName(s)[0];
             if (d.getElementById(id)) {return;}
             js = d.createElement(s); js.id = id;
             js.src = "//connect.facebook.net/en_US/sdk.js";
             fjs.parentNode.insertBefore(js, fjs);
           }(document, 'script', 'facebook-jssdk'));
        </script>
        <script id="dsq-count-scr" src="//huysblog.disqus.com/count.js" async></script>
        <script type="text/javascript" async src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script>
        <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
          tex2jax: {
            inlineMath: [['$','$'], ['\\(','\\)']],
            skipTags: ["script","noscript","style","textarea"]
          }
        });
        </script>
    </body>
</html>
